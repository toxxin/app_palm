<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>CanFestival: src/sdo.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CanFestival
   &#160;<span id="projectnumber">3.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sdo_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">sdo.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sdo_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">   This file is part of CanFestival, a library implementing CanOpen Stack.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">   Copyright (C): Edouard TISSERANT and Francis DUPIN</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">   See COPYING file for copyrights details.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">   This library is free software; you can redistribute it and/or</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">   modify it under the terms of the GNU Lesser General Public</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">   License as published by the Free Software Foundation; either</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">   version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">   This library is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">   Lesser General Public License for more details.</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">   You should have received a copy of the GNU Lesser General Public</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">   License along with this library; if not, write to the Free Software</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">   */</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">/* #define DEBUG_WAR_CONSOLE_ON */</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">/* #define DEBUG_ERR_CONSOLE_ON */</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;canfestival.h&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;sysdep.h&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">/* Uncomment if your compiler does not support inline functions */</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#define NO_INLINE</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#ifdef NO_INLINE</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define INLINE</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define INLINE inline</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">/*Internals prototypes*/</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;UNS8 <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>( <a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId );</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;INLINE UNS8 <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index,</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize, UNS8 useBlockMode);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;INLINE UNS8 <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/***************************************************************************/</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">/* SDO (un)packing macros */</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno"><a class="line" href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">   92</a></span>&#160;<span class="preprocessor">#define getSDOcs(byte) (byte &gt;&gt; 5)</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">   96</a></span>&#160;<span class="preprocessor">#define getSDOn2(byte) ((byte &gt;&gt; 2) &amp; 3)</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00100"></a><span class="lineno"><a class="line" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">  100</a></span>&#160;<span class="preprocessor">#define getSDOn3(byte) ((byte &gt;&gt; 1) &amp; 7)</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00104"></a><span class="lineno"><a class="line" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">  104</a></span>&#160;<span class="preprocessor">#define getSDOe(byte) ((byte &gt;&gt; 1) &amp; 1)</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00108"></a><span class="lineno"><a class="line" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">  108</a></span>&#160;<span class="preprocessor">#define getSDOs(byte) (byte &amp; 1)</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00112"></a><span class="lineno"><a class="line" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">  112</a></span>&#160;<span class="preprocessor">#define getSDOc(byte) (byte &amp; 1)</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00116"></a><span class="lineno"><a class="line" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">  116</a></span>&#160;<span class="preprocessor">#define getSDOt(byte) ((byte &gt;&gt; 4) &amp; 1)</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">  120</a></span>&#160;<span class="preprocessor">#define getSDOindex(byte1, byte2) (((UNS16)byte2 &lt;&lt; 8) | ((UNS16)byte1))</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00124"></a><span class="lineno"><a class="line" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">  124</a></span>&#160;<span class="preprocessor">#define getSDOsubIndex(byte3) (byte3)</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="sdo_8c.html#a80fb365a327b1fd8fda7f9634832f231">  128</a></span>&#160;<span class="preprocessor">#define getSDOblockSC(byte) (byte &amp; 3)</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="sdo_8c.html#a9309025e29b59e09026abcd3b45a5b61">  137</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a9309025e29b59e09026abcd3b45a5b61">SDOTimeoutAlarm</a>(<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS32 <span class="keywordtype">id</span>)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;{</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        UNS8 nodeId;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="comment">/* Get the client-&gt;server cobid.*/</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keywordflow">if</span> ((offset == 0) || ((offset+d-&gt;transfers[<span class="keywordtype">id</span>].CliServNbr) &gt; d-&gt;lastIndex-&gt;SDO_CLT)) {</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                return ;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        }</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        nodeId = (UNS8) *((UNS32*) d-&gt;objdict[offset+d-&gt;transfers[id].CliServNbr].pSubindex[3].pObject);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        MSG_ERR(0x1A01, <span class="stringliteral">&quot;SDO timeout. SDO response not received.&quot;</span>, 0);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        MSG_WAR(0x2A02, <span class="stringliteral">&quot;server node id : &quot;</span>, nodeId);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        MSG_WAR(0x2A02, <span class="stringliteral">&quot;         index : &quot;</span>, d-&gt;transfers[<span class="keywordtype">id</span>].index);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        MSG_WAR(0x2A02, <span class="stringliteral">&quot;      subIndex : &quot;</span>, d-&gt;transfers[<span class="keywordtype">id</span>].subIndex);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="comment">/* Reset timer handler */</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        d-&gt;transfers[id].timer = TIMER_NONE;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        <span class="comment">/*Set aborted state*/</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        d-&gt;transfers[id].state = SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="comment">/* Sending a SDO abort */</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <a class="code" href="sdo_8c.html#a8d0032d382891d6804947e9514fe3720">sendSDOabort</a>(d, d-&gt;transfers[<span class="keywordtype">id</span>].whoami, d-&gt;transfers[<span class="keywordtype">id</span>].CliServNbr,</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                        d-&gt;transfers[<span class="keywordtype">id</span>].index, d-&gt;transfers[<span class="keywordtype">id</span>].subIndex, SDOABT_TIMED_OUT);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        d-&gt;transfers[id].abortCode = SDOABT_TIMED_OUT;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="comment">/* Call the user function to inform of the problem.*/</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordflow">if</span>(d-&gt;transfers[<span class="keywordtype">id</span>].Callback)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                <span class="comment">/*If ther is a callback, it is responsible to close SDO transfer (client)*/</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                (*d-&gt;transfers[id].Callback)(d, nodeId);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="comment">/*Reset the line if (whoami == SDO_SERVER) or the callback did not close the line.</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">          Otherwise this sdo transfer would never be closed. */</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keywordflow">if</span>(d-&gt;transfers[<span class="keywordtype">id</span>].abortCode == SDOABT_TIMED_OUT) </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, (UNS8)<span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;}</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#define StopSDO_TIMER(id) \</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="preprocessor">        MSG_WAR(0x3A05, &quot;StopSDO_TIMER for line : &quot;, line);\</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">d-&gt;transfers[id].timer = DelAlarm(d-&gt;transfers[id].timer);</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor">#define StartSDO_TIMER(id) \</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="preprocessor">        MSG_WAR(0x3A06, &quot;StartSDO_TIMER for line : &quot;, line);\</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="preprocessor">d-&gt;transfers[id].timer = SetAlarm(d,id,&amp;SDOTimeoutAlarm,MS_TO_TIMEVAL(SDO_TIMEOUT_MS),0);</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor">#define RestartSDO_TIMER(id) \</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="preprocessor">        MSG_WAR(0x3A07, &quot;restartSDO_TIMER for line : &quot;, line);\</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">if(d-&gt;transfers[id].timer != TIMER_NONE) { StopSDO_TIMER(id) StartSDO_TIMER(id) }</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="sdo_8c.html#a1f4f07eccc4890a11ccf4f632da7740b">  186</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a1f4f07eccc4890a11ccf4f632da7740b">resetSDO</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;{</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        UNS8 j;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="comment">/* transfer structure initialization */</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keywordflow">for</span> (j = 0 ; j &lt; SDO_MAX_SIMULTANEOUS_TRANSFERS ; j++)</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, j);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;}</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno"><a class="line" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">  203</a></span>&#160;UNS32 <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">SDOlineToObjdict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;{</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        UNS32 size;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        UNS32 errorCode;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        MSG_WAR(0x3A08, <span class="stringliteral">&quot;Enter in SDOlineToObjdict &quot;</span>, line);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">/* if SDO initiated with e=0 and s=0 count is null, offset carry effective size*/</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keywordflow">if</span>( d-&gt;transfers[line].count == 0)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                d-&gt;transfers[line].count = d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        size = d-&gt;transfers[line].count;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> (size &gt; SDO_MAX_LENGTH_TRANSFER)</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        {</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                errorCode = <a class="code" href="group__od.html#ga3417b8ecd54a73528afc30b77f7d464c">setODentry</a>(d, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                                (<span class="keywordtype">void</span> *) d-&gt;transfers[line].dynamicData, &amp;size, 1);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                errorCode = <a class="code" href="group__od.html#ga3417b8ecd54a73528afc30b77f7d464c">setODentry</a>(d, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                                (<span class="keywordtype">void</span> *) d-&gt;transfers[line].data, &amp;size, 1);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        }</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="preprocessor"></span>        errorCode = <a class="code" href="group__od.html#ga3417b8ecd54a73528afc30b77f7d464c">setODentry</a>(d, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                        (<span class="keywordtype">void</span> *) d-&gt;transfers[line].data, &amp;size, 1);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">if</span> (errorCode != OD_SUCCESSFUL)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                <span class="keywordflow">return</span> errorCode;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        MSG_WAR(0x3A08, <span class="stringliteral">&quot;exit of SDOlineToObjdict &quot;</span>, line);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;}</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">  244</a></span>&#160;UNS32 <a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">objdictToSDOline</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line)</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    UNS32  size = SDO_MAX_LENGTH_TRANSFER;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        UNS8  dataType;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        UNS32 errorCode;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        MSG_WAR(0x3A05, <span class="stringliteral">&quot;objdict-&gt;line index : &quot;</span>, d-&gt;transfers[line].index);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        MSG_WAR(0x3A06, <span class="stringliteral">&quot;  subIndex : &quot;</span>, d-&gt;transfers[line].subIndex);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor"></span>    <span class="comment">/* Try to use the static buffer.                                            */</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        errorCode = <a class="code" href="group__od.html#ga811a637353eaa89cfae43957f7b3b68a">getODentry</a>(d,       d-&gt;transfers[line].index,</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                        d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                        (<span class="keywordtype">void</span> *)d-&gt;transfers[line].data,</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                        &amp;size, &amp;dataType, 1);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">if</span> (errorCode == SDOABT_OUT_OF_MEMORY) {</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="comment">/* The static buffer is too small, try again using a dynamic buffer.      *</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">        * &#39;size&#39; now contains the real size of the requested object.             */</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="keywordflow">if</span> (size &lt;= SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE) {</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            d-&gt;transfers[line].dynamicData = (UNS8 *) malloc(size * <span class="keyword">sizeof</span>(UNS8));</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData != NULL) {</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                d-&gt;transfers[line].dynamicDataSize = size;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                errorCode = <a class="code" href="group__od.html#ga811a637353eaa89cfae43957f7b3b68a">getODentry</a>(d,</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                d-&gt;transfers[line].index,</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                (<span class="keywordtype">void</span> *) d-&gt;transfers[line].dynamicData,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                &amp;d-&gt;transfers[line].dynamicDataSize,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                &amp;dataType,</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                1);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            }</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        }</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    }</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="preprocessor"></span>        errorCode = <a class="code" href="group__od.html#ga811a637353eaa89cfae43957f7b3b68a">getODentry</a>(d,       d-&gt;transfers[line].index,</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                        d-&gt;transfers[line].subIndex,</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                        (<span class="keywordtype">void</span> *)d-&gt;transfers[line].data,</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                        &amp;size, &amp;dataType, 1);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="keywordflow">if</span> (errorCode != OD_SUCCESSFUL)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="keywordflow">return</span> errorCode;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        d-&gt;transfers[line].count = size;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        d-&gt;transfers[line].offset = 0;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;}</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno"><a class="line" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">  302</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line, UNS32 nbBytes, UNS8* data) {</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        UNS32 offset;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="preprocessor">#ifndef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; SDO_MAX_LENGTH_TRANSFER) {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                MSG_ERR(0x1A10,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFER&quot;</span>, nbBytes);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        }</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; d-&gt;transfers[line].count) {</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                MSG_ERR(0x1A11,<span class="stringliteral">&quot;SDO Size of data too large. Exceed count&quot;</span>, nbBytes);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        offset = d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> (d-&gt;transfers[line].count &lt;= SDO_MAX_LENGTH_TRANSFER)</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        {</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                        * (data + i) = d-&gt;transfers[line].data[offset + i];</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData == NULL)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                {</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                        MSG_ERR(0x1A11,<span class="stringliteral">&quot;SDO&#39;s dynamic buffer not allocated. Line&quot;</span>, line);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                }</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                        * (data + i) = d-&gt;transfers[line].dynamicData[offset + i];</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        }</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                * (data + i) = d-&gt;transfers[line].data[offset + i];</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="preprocessor"></span>        d-&gt;transfers[line].offset = d-&gt;transfers[line].offset + nbBytes;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;}</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno"><a class="line" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">  352</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line, UNS32 nbBytes, UNS8* data)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;{</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        UNS32 offset;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="preprocessor">#ifndef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; SDO_MAX_LENGTH_TRANSFER) {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                MSG_ERR(0x1A15,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFER&quot;</span>, nbBytes);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        }</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        offset = d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                UNS8* lineData = d-&gt;transfers[line].data;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; SDO_MAX_LENGTH_TRANSFER) {</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                        <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData == NULL) {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                                d-&gt;transfers[line].dynamicData = (UNS8*) malloc(SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                                d-&gt;transfers[line].dynamicDataSize = SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData == NULL) {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                                        MSG_ERR(0x1A15,<span class="stringliteral">&quot;SDO allocating dynamic buffer failed, size&quot;</span>, SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                                }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                                <span class="comment">//Copy present data</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                                memcpy(d-&gt;transfers[line].dynamicData, d-&gt;transfers[line].data, offset);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                        }</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; d-&gt;transfers[line].dynamicDataSize)</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                        {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                                UNS8* newDynamicBuffer = (UNS8*) realloc(d-&gt;transfers[line].dynamicData, d-&gt;transfers[line].dynamicDataSize + SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                                <span class="keywordflow">if</span> (newDynamicBuffer == NULL) {</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                                        MSG_ERR(0x1A15,<span class="stringliteral">&quot;SDO reallocating dynamic buffer failed, size&quot;</span>, d-&gt;transfers[line].dynamicDataSize + SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                                }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                                d-&gt;transfers[line].dynamicData = newDynamicBuffer;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                                d-&gt;transfers[line].dynamicDataSize += SDO_DYNAMIC_BUFFER_ALLOCATION_SIZE;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                        }</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                        lineData = d-&gt;transfers[line].dynamicData;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                }</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                        lineData[offset + i] = * (data + i);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                d-&gt;transfers[line].data[offset + i] = * (data + i);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        d-&gt;transfers[line].offset = d-&gt;transfers[line].offset + nbBytes;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;}</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno"><a class="line" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">  416</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 CliServNbr, UNS8 whoami, UNS16 index,</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                UNS8 subIndex, UNS32 abortCode)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;{</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>( d, CliServNbr, whoami, &amp;line );</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordflow">if</span> (!err) <span class="comment">/* If a line on use have been found.*/</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                MSG_WAR(0x3A20, <span class="stringliteral">&quot;FailedSDO : line found : &quot;</span>, line);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="keywordflow">if</span> ((! err) &amp;&amp; (whoami == SDO_SERVER)) {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>( d, line );</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                MSG_WAR(0x3A21, <span class="stringliteral">&quot;FailedSDO : line released : &quot;</span>, line);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="keywordflow">if</span> ((! err) &amp;&amp; (whoami == SDO_CLIENT)) {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                StopSDO_TIMER(line);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                d-&gt;transfers[line].state = SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                d-&gt;transfers[line].abortCode = abortCode;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        }</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        MSG_WAR(0x3A22, <span class="stringliteral">&quot;Sending SDO abort &quot;</span>, 0);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        err = <a class="code" href="sdo_8c.html#a8d0032d382891d6804947e9514fe3720">sendSDOabort</a>(d, whoami, CliServNbr, index, subIndex, abortCode);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                MSG_WAR(0x3A23, <span class="stringliteral">&quot;Unable to send the SDO abort&quot;</span>, 0);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;}</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno"><a class="line" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">  448</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a> ( <a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line )</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;{</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        UNS32 i;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        MSG_WAR(0x3A25, <span class="stringliteral">&quot;reset SDO line nb : &quot;</span>, line);</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, 0, 0, 0, SDO_RESET);</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_LENGTH_TRANSFER ; i++)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                d-&gt;transfers[line].data[i] = 0;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        d-&gt;transfers[line].whoami = 0;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        d-&gt;transfers[line].abortCode = 0;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;}</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno"><a class="line" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">  471</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line, UNS8 CliServNbr, UNS16 index, UNS8 subIndex, UNS8 state)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;{</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        MSG_WAR(0x3A25, <span class="stringliteral">&quot;init SDO line nb : &quot;</span>, line);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">if</span> (state == SDO_DOWNLOAD_IN_PROGRESS       || state == SDO_UPLOAD_IN_PROGRESS ||</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        state == SDO_BLOCK_DOWNLOAD_IN_PROGRESS || state == SDO_BLOCK_UPLOAD_IN_PROGRESS){</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                StartSDO_TIMER(line)</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                StopSDO_TIMER(line)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        }</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        d-&gt;transfers[line].CliServNbr = CliServNbr;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        d-&gt;transfers[line].index = index;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        d-&gt;transfers[line].subIndex = subIndex;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        d-&gt;transfers[line].state = state;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        d-&gt;transfers[line].toggle = 0;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        d-&gt;transfers[line].count = 0;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        d-&gt;transfers[line].offset = 0;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    d-&gt;transfers[line].peerCRCsupport = 0;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    d-&gt;transfers[line].blksize = 0;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    d-&gt;transfers[line].ackseq = 0;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    d-&gt;transfers[line].objsize = 0;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    d-&gt;transfers[line].lastblockoffset = 0;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    d-&gt;transfers[line].seqno = 0;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    d-&gt;transfers[line].endfield = 0;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    d-&gt;transfers[line].rxstep = RXSTEP_INIT;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        d-&gt;transfers[line].dataType = 0;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        d-&gt;transfers[line].Callback = NULL;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="preprocessor"></span>        free(d-&gt;transfers[line].dynamicData);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        d-&gt;transfers[line].dynamicData = 0;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        d-&gt;transfers[line].dynamicDataSize = 0;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;}</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno"><a class="line" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">  514</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a> ( <a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 whoami, UNS8 *line )</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;{</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_SIMULTANEOUS_TRANSFERS ; i++){</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                <span class="keywordflow">if</span> ( d-&gt;transfers[i].state == SDO_RESET ) {</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                        *line = i;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                        d-&gt;transfers[i].whoami = whoami;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                } <span class="comment">/* end if */</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        } <span class="comment">/* end for */</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        MSG_ERR(0x1A25, <span class="stringliteral">&quot;Too many SDO in progress. Aborted.&quot;</span>, i);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;}</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div>
<div class="line"><a name="l00540"></a><span class="lineno"><a class="line" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">  540</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 CliServNbr, UNS8 whoami, UNS8 *line)</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;{</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_SIMULTANEOUS_TRANSFERS ; i++){</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                <span class="keywordflow">if</span> ( (d-&gt;transfers[i].state != SDO_RESET) &amp;&amp;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                                (d-&gt;transfers[i].state != SDO_ABORTED_INTERNAL) &amp;&amp;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                                (d-&gt;transfers[i].CliServNbr == CliServNbr) &amp;&amp;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                                (d-&gt;transfers[i].whoami == whoami) ) {</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                        <span class="keywordflow">if</span> (line) *line = i;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                }</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        }</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;}</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno"><a class="line" href="sdo_8c.html#a306682ff5ce933d4db07547e467e9057">  567</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a306682ff5ce933d4db07547e467e9057">getSDOlineToClose</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 CliServNbr, UNS8 whoami, UNS8 *line)</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;{</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_SIMULTANEOUS_TRANSFERS ; i++){</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                <span class="keywordflow">if</span> ( (d-&gt;transfers[i].state != SDO_RESET) &amp;&amp;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                                (d-&gt;transfers[i].CliServNbr == CliServNbr) &amp;&amp;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                                (d-&gt;transfers[i].whoami == whoami) ) {</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                        <span class="keywordflow">if</span> (line) *line = i;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;}</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno"><a class="line" href="sdo_8c.html#a555a772d3a88a29c495f33513f8b2d58">  593</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a555a772d3a88a29c495f33513f8b2d58">closeSDOtransfer</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS8 whoami)</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;{</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    UNS8 CliNbr;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="comment">/* First let&#39;s find the corresponding SDO client in our OD  */</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        CliNbr = <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>(d, nodeId);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">if</span>(CliNbr &gt;= 0xFE)</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    err = <a class="code" href="sdo_8c.html#a306682ff5ce933d4db07547e467e9057">getSDOlineToClose</a>(d, CliNbr, whoami, &amp;line);</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                MSG_WAR(0x2A30, <span class="stringliteral">&quot;No SDO communication to close&quot;</span>, 0);</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;}</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00620"></a><span class="lineno"><a class="line" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">  620</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line, UNS32 * nbBytes)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;{</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        <span class="comment">/* SDO initiated with e=0 and s=0 have count set to null */</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">if</span> (d-&gt;transfers[line].count == 0)</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                * nbBytes = 0;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                * nbBytes = d-&gt;transfers[line].count - d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;}</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00639"></a><span class="lineno"><a class="line" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">  639</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">setSDOlineRestBytes</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 line, UNS32 nbBytes)</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;{</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="preprocessor">#ifndef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> (nbBytes &gt; SDO_MAX_LENGTH_TRANSFER) {</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                MSG_ERR(0x1A35,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFER&quot;</span>, nbBytes);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        }</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        d-&gt;transfers[line].count = nbBytes;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;}</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno"><a class="line" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">  662</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 whoami, UNS8 CliServNbr, UNS8 *pData)</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;{</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <a class="code" href="structMessage.html">Message</a> m;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        MSG_WAR(0x3A38, <span class="stringliteral">&quot;sendSDO&quot;</span>,0);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">if</span>( !((d-&gt;nodeState == Operational) ||  (d-&gt;nodeState == Pre_operational ))) {</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                MSG_WAR(0x2A39, <span class="stringliteral">&quot;unable to send the SDO (not in op or pre-op mode&quot;</span>, d-&gt;nodeState);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="comment">/*get the server-&gt;client cobid*/</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">if</span> ( whoami == SDO_SERVER )     {</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                offset = d-&gt;firstIndex-&gt;SDO_SVR;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                <span class="keywordflow">if</span> ((offset == 0) || ((offset+CliServNbr) &gt; d-&gt;lastIndex-&gt;SDO_SVR)) {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                        MSG_ERR(0x1A42, <span class="stringliteral">&quot;SendSDO : SDO server not found&quot;</span>, 0);</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                }</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                m.<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a> = (UNS16) *((UNS32*) d-&gt;objdict[offset+CliServNbr].pSubindex[2].pObject);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                MSG_WAR(0x3A41, <span class="stringliteral">&quot;I am server Tx cobId : &quot;</span>, m.<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>);</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        }</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="keywordflow">else</span> {                  <span class="comment">/*case client*/</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                <span class="comment">/* Get the client-&gt;server cobid.*/</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                <span class="keywordflow">if</span> ((offset == 0) || ((offset+CliServNbr) &gt; d-&gt;lastIndex-&gt;SDO_CLT)) {</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                        MSG_ERR(0x1A42, <span class="stringliteral">&quot;SendSDO : SDO client not found&quot;</span>, 0);</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                m.<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a> = (UNS16) *((UNS32*) d-&gt;objdict[offset+CliServNbr].pSubindex[1].pObject);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                MSG_WAR(0x3A41, <span class="stringliteral">&quot;I am client Tx cobId : &quot;</span>, m.<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>);</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        }</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="comment">/* message copy for sending */</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        m.<a class="code" href="structMessage.html#a41c5a4e7eaeb2c2ae1af2b2c83129615">rtr</a> = NOT_A_REQUEST;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="comment">/* the length of SDO must be 8 */</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        m.<a class="code" href="structMessage.html#ad1dd9a88dda088ff4c7073d49613613d">len</a> = 8;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="keywordflow">for</span> (i = 0 ; i &lt; 8 ; i++) {</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                m.<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[i] =  pData[i];</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        }</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">return</span> canSend(d-&gt;canHandle,&amp;m);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;}</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div>
<div class="line"><a name="l00715"></a><span class="lineno"><a class="line" href="sdo_8c.html#a8d0032d382891d6804947e9514fe3720">  715</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a8d0032d382891d6804947e9514fe3720">sendSDOabort</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 whoami, UNS8 CliServNbr, UNS16 index, UNS8 subIndex, UNS32 abortCode)</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;{</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        UNS8 data[8];</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        UNS8 ret;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        MSG_WAR(0x2A50,<span class="stringliteral">&quot;Sending SDO abort &quot;</span>, abortCode);</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        data[0] = 0x80;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="comment">/* Index */</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        data[1] = index &amp; 0xFF; <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="comment">/* Subindex */</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        data[3] = subIndex;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="comment">/* Data */</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        data[4] = (UNS8)(abortCode &amp; 0xFF);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        data[5] = (UNS8)((abortCode &gt;&gt; 8) &amp; 0xFF);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        data[6] = (UNS8)((abortCode &gt;&gt; 16) &amp; 0xFF);</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        data[7] = (UNS8)((abortCode &gt;&gt; 24) &amp; 0xFF);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        ret = <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;}</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div>
<div class="line"><a name="l00745"></a><span class="lineno"><a class="line" href="sdo_8c.html#a2a93a7c780472b1d8666d89aa270f661">  745</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a2a93a7c780472b1d8666d89aa270f661">proceedSDO</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, <a class="code" href="structMessage.html">Message</a> *m)</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;{</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        UNS8 cs;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        UNS32 nbBytes;          <span class="comment">/* received or to be transmited. */</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        UNS8 nodeId = 0;        <span class="comment">/* The node Id of the server if client otherwise unused */</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        UNS8 CliServNbr;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        UNS8 whoami = SDO_UNKNOWN;  <span class="comment">/* SDO_SERVER or SDO_CLIENT.*/</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        UNS32 errorCode; <span class="comment">/* while reading or writing in the local object dictionary.*/</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        UNS8 data[8];    <span class="comment">/* data for SDO to transmit */</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        UNS16 index;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        UNS8 subIndex;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        UNS32 abortCode;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        UNS32 i;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        UNS8    j;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        UNS32 *pCobId = NULL;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        UNS16 lastIndex;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        UNS8 SubCommand;        <span class="comment">/* Block transfer only */</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    UNS8 SeqNo;         <span class="comment">/* Sequence number in block transfer */</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    UNS8 AckSeq;        <span class="comment">/* Sequence number of last segment that was received successfully */</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        UNS8 NbBytesNoData; <span class="comment">/* Number of bytes that do not contain data in last segment of block transfer */</span> </div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        MSG_WAR(0x3A60, <span class="stringliteral">&quot;proceedSDO &quot;</span>, 0);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        whoami = SDO_UNKNOWN;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        <span class="comment">/* Looking for the cobId in the object dictionary. */</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <span class="comment">/* Am-I a server ? */</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        offset = d-&gt;firstIndex-&gt;SDO_SVR;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        lastIndex = d-&gt;lastIndex-&gt;SDO_SVR;</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        j = 0;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="keywordflow">if</span>(offset) <span class="keywordflow">while</span> (offset &lt;= lastIndex) {</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 1) {</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                        MSG_ERR(0x1A61, <span class="stringliteral">&quot;Subindex 1  not found at index &quot;</span>, 0x1200 + j);</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                <span class="comment">/* Looking for the cobid received. */</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                pCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[1].pObject;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                if ( *pCobId == UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>) ) {</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                        whoami = SDO_SERVER;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                        MSG_WAR(0x3A62, <span class="stringliteral">&quot;proceedSDO. I am server. index : &quot;</span>, 0x1200 + j);</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                        <span class="comment">/* Defining Server number = index minus 0x1200 where the cobid received is defined. */</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                        CliServNbr = j;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                }</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                j++;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                offset++;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        } <span class="comment">/* end while */</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <span class="keywordflow">if</span> (whoami == SDO_UNKNOWN) {</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                <span class="comment">/* Am-I client ? */</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                j = 0;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                <span class="keywordflow">if</span>(offset) <span class="keywordflow">while</span> (offset &lt;= lastIndex) {</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                        <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                                MSG_ERR(0x1A63, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + j);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                        }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                        <span class="comment">/* Looking for the cobid received. */</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                        pCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[2].pObject;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                        if (*pCobId == UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>) ) {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                                whoami = SDO_CLIENT;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                MSG_WAR(0x3A64, <span class="stringliteral">&quot;proceedSDO. I am client index : &quot;</span>, 0x1280 + j);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                                <span class="comment">/* Defining Client number = index minus 0x1280 where the cobid received is defined. */</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                                CliServNbr = j;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                                <span class="comment">/* Reading the server node ID, if client it is mandatory in the OD */</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                                nodeId = *((UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject);</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                        }</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                        j++;</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                        offset++;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                } <span class="comment">/* end while */</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        }</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="keywordflow">if</span> (whoami == SDO_UNKNOWN) {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                <span class="keywordflow">return</span> 0xFF;<span class="comment">/* This SDO was not for us ! */</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        }</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="comment">/* Test if the size of the SDO is ok */</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">if</span> ( (*m).len != 8) {</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                MSG_ERR(0x1A67, <span class="stringliteral">&quot;Error size SDO&quot;</span>, 0);</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        }</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        <span class="keywordflow">if</span> (whoami == SDO_CLIENT) {</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                MSG_WAR(0x3A68, <span class="stringliteral">&quot;I am CLIENT number &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        }</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                MSG_WAR(0x3A69, <span class="stringliteral">&quot;I am SERVER number &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        }</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        <span class="comment">/* Look for an SDO transfer already initiated. */</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>( d, CliServNbr, whoami, &amp;line );</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        <span class="comment">/* Let&#39;s find cs value, first it is set as &quot;not valid&quot; */</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        cs = 0xFF; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="comment">/* Special cases for block transfer : in frames with segment data cs is not spcified */</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        <span class="keywordflow">if</span> (!err) {</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                <span class="keywordflow">if</span> ((whoami == SDO_SERVER) &amp;&amp; (d-&gt;transfers[line].state == SDO_BLOCK_DOWNLOAD_IN_PROGRESS) ||</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                        (whoami == SDO_CLIENT) &amp;&amp; (d-&gt;transfers[line].state == SDO_BLOCK_UPLOAD_IN_PROGRESS)) {         </div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                        <span class="keywordflow">if</span>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] == 0x80)  <span class="comment">/* If first byte is 0x80 it is an abort frame (seqno = 0 not allowed) */</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                                cs = 4;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                                cs = 6;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                }</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        <span class="comment">/* Other cases : cs is specified */</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        <span class="keywordflow">if</span> (cs == 0xFF)</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                cs = <a class="code" href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">getSDOcs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        <span class="comment">/* Testing the command specifier */</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="comment">/* Allowed : cs = 0, 1, 2, 3, 4, 5, 6 */</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="comment">/* cs = other : Not allowed -&gt; abort. */</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <span class="keywordflow">switch</span> (cs) {</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                <span class="keywordflow">case</span> 0:</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                        <span class="comment">/* I am SERVER */</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) {</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                                <span class="comment">/* Receiving a download segment data : an SDO transfer should have been yet initiated. */</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                                        MSG_ERR(0x1A70, <span class="stringliteral">&quot;SDO error : Received download segment for unstarted trans. index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                                                        CliServNbr);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                                }</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                                <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;                                        MSG_WAR(0x3A71, <span class="stringliteral">&quot;Received SDO download segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                                index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                                <span class="comment">/* Toggle test. */</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                                        MSG_ERR(0x1A72, <span class="stringliteral">&quot;SDO error : Toggle error : &quot;</span>, <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]));</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                                }</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                                <span class="comment">/* Nb of data to be downloaded */</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                                nbBytes = 7 - <a class="code" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">getSDOn3</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                                <span class="comment">/* Store the data in the transfer structure. */</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                                err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, nbBytes, (*m).data + 1);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                                }</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                                <span class="comment">/* Sending the SDO response, CS = 1 */</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                                data[0] = (1 &lt;&lt; 5) | (d-&gt;transfers[line].toggle &lt;&lt; 4);</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                                <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                                        data[i] = 0;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                                MSG_WAR(0x3A73, <span class="stringliteral">&quot;SDO. Send response to download request defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                                <span class="comment">/* Inverting the toggle for the next segment. */</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                                d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                                <span class="comment">/* If it was the last segment, */</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">getSDOc</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                                        <span class="comment">/* Transfering line data to object dictionary. */</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                                        <span class="comment">/* The code does not use the &quot;d&quot; of initiate frame. So it is safe if e=s=0 */</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                                        errorCode = <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">SDOlineToObjdict</a>(d, line);</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                                        <span class="keywordflow">if</span> (errorCode) {</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                                                MSG_ERR(0x1A54, <span class="stringliteral">&quot;SDO error : Unable to copy the data in the object dictionary&quot;</span>, 0);</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, errorCode);</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                                        }</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                                        <span class="comment">/* Release of the line */</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                                        MSG_WAR(0x3A74, <span class="stringliteral">&quot;SDO. End of download defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                                }</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                        } <span class="comment">/* end if SERVER */</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                        <span class="keywordflow">else</span> { <span class="comment">/* if CLIENT */</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                                <span class="comment">/* I am CLIENT */</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                                <span class="comment">/* It is a request for a previous upload segment. We should find a line opened for this.*/</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                                        MSG_ERR(0x1A75, <span class="stringliteral">&quot;SDO error : Received segment response for unknown trans. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                                }</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                                <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                                        index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                                <span class="comment">/* test of the toggle; */</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                                        MSG_ERR(0x1A76, <span class="stringliteral">&quot;SDO error : Received segment response Toggle error. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                                }</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                                <span class="comment">/* nb of data to be uploaded */</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                                nbBytes = 7 - <a class="code" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">getSDOn3</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                                <span class="comment">/* Storing the data in the line structure. */</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                                err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, nbBytes, (*m).data + 1);</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;                                }</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                                <span class="comment">/* Inverting the toggle for the next segment. */</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                                d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                                <span class="comment">/* If it was the last segment,*/</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                                <span class="keywordflow">if</span> ( <a class="code" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">getSDOc</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                                        <span class="comment">/* Put in state finished */</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                                        <span class="comment">/* The code is safe for the case e=s=0 in initiate frame. */</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                                                d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                                        MSG_WAR(0x3A77, <span class="stringliteral">&quot;SDO. End of upload from node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                                }</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                                <span class="keywordflow">else</span> { <span class="comment">/* more segments to receive */</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                                        <span class="comment">/* Sending the request for the next segment. */</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                                        data[0] = (3 &lt;&lt; 5) | (d-&gt;transfers[line].toggle &lt;&lt; 4);</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                                        <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                                        MSG_WAR(0x3A78, <span class="stringliteral">&quot;SDO send upload segment request to nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                                }</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                        } <span class="comment">/* End if CLIENT */</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                <span class="keywordflow">case</span> 1:</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                        <span class="comment">/* I am SERVER */</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                        <span class="comment">/* Receive of an initiate download */</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) {</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                                index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                                subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                                MSG_WAR(0x3A79, <span class="stringliteral">&quot;Received SDO Initiate Download (to store data) defined at index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                                                CliServNbr);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                                MSG_WAR(0x3A80, <span class="stringliteral">&quot;Writing at index : &quot;</span>, index);</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                                MSG_WAR(0x3A80, <span class="stringliteral">&quot;Writing at subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                                <span class="comment">/* Search if a SDO transfer have been yet initiated */</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                                <span class="keywordflow">if</span> (! err) {</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                                        MSG_ERR(0x1A81, <span class="stringliteral">&quot;SDO error : Transmission yet started.&quot;</span>, 0);</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                                }</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                                <span class="comment">/* No line on use. Great ! */</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                                <span class="comment">/* Try to open a new line. */</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                                err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, whoami, &amp;line );</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                                        MSG_ERR(0x1A82, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                                }</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                                <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliServNbr, index, subIndex, SDO_DOWNLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">getSDOe</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) { <span class="comment">/* If SDO expedited */</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                                        <span class="comment">/* nb of data to be downloaded */</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                                        nbBytes = 4 - <a class="code" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">getSDOn2</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                                        <span class="comment">/* Storing the data in the line structure. */</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                                        d-&gt;transfers[line].count = nbBytes;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, nbBytes, (*m).data + 4);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                                        }</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                                        <span class="comment">/* SDO expedited -&gt; transfer finished. Data can be stored in the dictionary. */</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                                        <span class="comment">/*The line will be reseted when it is downloading in the dictionary. */</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                                        MSG_WAR(0x3A83, <span class="stringliteral">&quot;SDO Initiate Download is an expedited transfer. Finished. &quot;</span>, 0);</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                                        <span class="comment">/* Transfering line data to object dictionary. */</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                                        errorCode = <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">SDOlineToObjdict</a>(d, line);</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                                        <span class="keywordflow">if</span> (errorCode) {</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                                                MSG_ERR(0x1A84, <span class="stringliteral">&quot;SDO error : Unable to copy the data in the object dictionary&quot;</span>, 0);</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, errorCode);</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                                        }</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                                        <span class="comment">/* Release of the line. */</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                                }</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                                <span class="keywordflow">else</span> {<span class="comment">/* So, if it is not an expedited transfer */</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                                        <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">getSDOs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                                                nbBytes = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4]) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5])&lt;&lt;8) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6])&lt;&lt;16) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7])&lt;&lt;24);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">setSDOlineRestBytes</a>(d, line, nbBytes);</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                                                }</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                                        }</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                                }</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                                <span class="comment">/*Sending a SDO, cs=3*/</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                                data[0] = 3 &lt;&lt; 5;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                                data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                                data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                                data[3] = subIndex;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                                <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                                        data[i] = 0;</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                        } <span class="comment">/* end if I am SERVER */</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                                <span class="comment">/* I am CLIENT */</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                                <span class="comment">/* It is a response for a previous download segment. We should find a line opened for this. */</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                                        MSG_ERR(0x1A85, <span class="stringliteral">&quot;SDO error : Received segment response for unknown trans. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                                }</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                                <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                                        index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                                <span class="comment">/* test of the toggle; */</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                                        MSG_ERR(0x1A86, <span class="stringliteral">&quot;SDO error : Received segment response Toggle error. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                                }</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                                <span class="comment">/* End transmission or downloading next segment. We need to know if it will be the last one. */</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                                <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                                <span class="keywordflow">if</span> (nbBytes == 0) {</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                                        MSG_WAR(0x3A87, <span class="stringliteral">&quot;SDO End download. segment response received. OK. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                                                d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                                        <span class="keywordflow">return</span> 0x00;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                                }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                                <span class="comment">/* At least one transfer to send.       */</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                                <span class="keywordflow">if</span> (nbBytes &gt; 7) {</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                                        <span class="comment">/* several segments to download.*/</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                                        <span class="comment">/* code to send the next segment. (cs = 0; c = 0) */</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                                        d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                                        data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, 7, data + 1);</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                                        }</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                                }</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                                        <span class="comment">/* Last segment. */</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;                                        <span class="comment">/* code to send the last segment. (cs = 0; c = 1)*/</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                                        d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                                        data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 1);</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                                        }</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                                        <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                                }</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                                MSG_WAR(0x3A88, <span class="stringliteral">&quot;SDO sending download segment to nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                        } <span class="comment">/* end if I am a CLIENT */</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                <span class="keywordflow">case</span> 2:</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                        <span class="comment">/* I am SERVER */</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                        <span class="comment">/* Receive of an initiate upload.*/</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) {</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                                index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                                subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                                MSG_WAR(0x3A89, <span class="stringliteral">&quot;Received SDO Initiate upload (to send data) defined at index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                                                CliServNbr);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                                MSG_WAR(0x3A90, <span class="stringliteral">&quot;Reading at index : &quot;</span>, index);</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                                MSG_WAR(0x3A91, <span class="stringliteral">&quot;Reading at subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                                <span class="comment">/* Search if a SDO transfer have been yet initiated*/</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                                <span class="keywordflow">if</span> (! err) {</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                                        MSG_ERR(0x1A92, <span class="stringliteral">&quot;SDO error : Transmission yet started at line : &quot;</span>, line);</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                                        MSG_WAR(0x3A93, <span class="stringliteral">&quot;Server Nbr = &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                                }</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                                <span class="comment">/* No line on use. Great !*/</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                                <span class="comment">/* Try to open a new line.*/</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                                err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, whoami, &amp;line );</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                                        MSG_ERR(0x1A71, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                                }</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                                <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliServNbr, index, subIndex, SDO_UPLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                                <span class="comment">/* Transfer data from dictionary to the line structure. */</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                                errorCode = <a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">objdictToSDOline</a>(d, line);</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                                <span class="keywordflow">if</span> (errorCode) {</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                                        MSG_ERR(0x1A94, <span class="stringliteral">&quot;SDO error : Unable to copy the data from object dictionary. Err code : &quot;</span>,</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                                                        errorCode);</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, errorCode);</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                                }</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                                <span class="comment">/* Preparing the response.*/</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                                <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes); <span class="comment">/* Nb bytes to transfer ? */</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                                <span class="keywordflow">if</span> (nbBytes &gt; 4) {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                                        <span class="comment">/* normal transfer. (segmented). */</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                                        <span class="comment">/* code to send the initiate upload response. (cs = 2) */</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                                        data[0] = (2 &lt;&lt; 5) | 1;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;                                        data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;                                        data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                                        data[3] = subIndex;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;                                        data[4] = (UNS8) nbBytes;</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                                        data[5] = (UNS8) (nbBytes &gt;&gt; 8);</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                                        data[6] = (UNS8) (nbBytes &gt;&gt; 16);</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                                        data[7] = (UNS8) (nbBytes &gt;&gt; 24);</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                                        MSG_WAR(0x3A95, <span class="stringliteral">&quot;SDO. Sending normal upload initiate response defined at index 0x1200 + &quot;</span>, nodeId);</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;                                }</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;                                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;                                        <span class="comment">/* Expedited upload. (cs = 2 ; e = 1) */</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                                        data[0] = (UNS8)((2 &lt;&lt; 5) | ((4 - nbBytes) &lt;&lt; 2) | 3);</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                                        data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                                        data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                                        data[3] = subIndex;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 4);</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;                                        }</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;                                        <span class="keywordflow">for</span> (i = 4 + nbBytes ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                                        MSG_WAR(0x3A96, <span class="stringliteral">&quot;SDO. Sending expedited upload initiate response defined at index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                                                        CliServNbr);</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                                        <span class="comment">/* Release the line.*/</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                                }</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                        } <span class="comment">/* end if I am SERVER*/</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                                <span class="comment">/* I am CLIENT */</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                                <span class="comment">/* It is the response for the previous initiate upload request.*/</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                                <span class="comment">/* We should find a line opened for this. */</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                                        MSG_ERR(0x1A97, <span class="stringliteral">&quot;SDO error : Received response for unknown upload request from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                                }</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                                <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                                        index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                                <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">getSDOe</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) { <span class="comment">/* If SDO expedited */</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                                        <span class="comment">/* nb of data to be uploaded */</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                                        nbBytes = 4 - <a class="code" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">getSDOn2</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                                        <span class="comment">/* Storing the data in the line structure. */</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, nbBytes, (*m).data + 4);</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                                        }</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                                        <span class="comment">/* SDO expedited -&gt; transfer finished. data are available via  getReadResultNetworkDict(). */</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                                        MSG_WAR(0x3A98, <span class="stringliteral">&quot;SDO expedited upload finished. Response received from node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                                                d-&gt;transfers[line].count = nbBytes;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                                        d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                                }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                                <span class="keywordflow">else</span> { <span class="comment">/* So, if it is not an expedited transfer */</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                                        <span class="comment">/* Storing the nb of data to receive. */</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                                        <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">getSDOs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                                                nbBytes = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5])&lt;&lt;8) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6])&lt;&lt;16) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7])&lt;&lt;24);</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">setSDOlineRestBytes</a>(d, line, nbBytes);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                                                }</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                                        }</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                                        <span class="comment">/* Requesting next segment. (cs = 3) */</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                                        data[0] = 3 &lt;&lt; 5;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                                        <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                                        MSG_WAR(0x3A99, <span class="stringliteral">&quot;SDO. Sending upload segment request to node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                                }</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                        } <span class="comment">/* End if CLIENT */</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                <span class="keywordflow">case</span> 3:</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                        <span class="comment">/* I am SERVER */</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) {</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                                <span class="comment">/* Receiving a upload segment. */</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                                <span class="comment">/* A SDO transfer should have been yet initiated. */</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                                        MSG_ERR(0x1AA0, <span class="stringliteral">&quot;SDO error : Received upload segment for unstarted trans. index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                                                        CliServNbr);</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                                }</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                                <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                                        MSG_WAR(0x3AA1, <span class="stringliteral">&quot;Received SDO upload segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                                index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                                <span class="comment">/* Toggle test.*/</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                                        MSG_ERR(0x1AA2, <span class="stringliteral">&quot;SDO error : Toggle error : &quot;</span>, <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]));</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                                }</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                                <span class="comment">/* Uploading next segment. We need to know if it will be the last one. */</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                                <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                                <span class="keywordflow">if</span> (nbBytes &gt; 7) {</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                                        <span class="comment">/* The segment to transfer is not the last one.*/</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                                        <span class="comment">/* code to send the next segment. (cs = 0; c = 0) */</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                                        data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, 7, data + 1);</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                                        }</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                                        <span class="comment">/* Inverting the toggle for the next tranfert. */</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                                        d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                                        MSG_WAR(0x3AA3, <span class="stringliteral">&quot;SDO. Sending upload segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;                                }</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                                        <span class="comment">/* Last segment. */</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                                        <span class="comment">/* code to send the last segment. (cs = 0; c = 1) */</span></div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                                        data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 1);</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                                        }</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                                        <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                                        MSG_WAR(0x3AA4, <span class="stringliteral">&quot;SDO. Sending last upload segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                                        <span class="comment">/* Release the line */</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                                }</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;                        } <span class="comment">/* end if SERVER*/</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                                <span class="comment">/* I am CLIENT */</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;                                <span class="comment">/* It is the response for the previous initiate download request. */</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;                                <span class="comment">/* We should find a line opened for this. */</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;                                <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;                                        err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;                                        MSG_ERR(0x1AA5, <span class="stringliteral">&quot;SDO error : Received response for unknown download request from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                                }</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;                                <span class="comment">/* Reset the watchdog */</span></div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                                RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                                        index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                                subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;                                <span class="comment">/* End transmission or requesting  next segment. */</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                                <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                                <span class="keywordflow">if</span> (nbBytes == 0) {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                                        MSG_WAR(0x3AA6, <span class="stringliteral">&quot;SDO End download expedited. Response received. from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                                                d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                                        <span class="keywordflow">return</span> 0x00;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;                                }</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                                <span class="keywordflow">if</span> (nbBytes &gt; 7) {</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                                        <span class="comment">/* more than one request to send */</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                                        <span class="comment">/* code to send the next segment. (cs = 0; c = 0)       */</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                                        data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, 7, data + 1);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                                        }</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                                }</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                                        <span class="comment">/* Last segment.*/</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                                        <span class="comment">/* code to send the last segment. (cs = 0; c = 1)       */</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                                        data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 1);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                                        }</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                                        <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                                }</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                                MSG_WAR(0x3AA7, <span class="stringliteral">&quot;SDO sending download segment to nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                        } <span class="comment">/* end if I am a CLIENT               */</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                <span class="keywordflow">case</span> 4:</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                        abortCode =</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                                (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] |</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                                ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5] &lt;&lt; 8) |</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                                ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6] &lt;&lt; 16) |</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                                ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7] &lt;&lt; 24);</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                        <span class="comment">/* Received SDO abort. */</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) {</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;                                <span class="keywordflow">if</span> (!err) {</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>( d, line );</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                                        MSG_WAR(0x3AA8, <span class="stringliteral">&quot;SD0. Received SDO abort. Line released. Code : &quot;</span>, abortCode);</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                                }</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                                        MSG_WAR(0x3AA9, <span class="stringliteral">&quot;SD0. Received SDO abort. No line found. Code : &quot;</span>, abortCode);</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                                <span class="comment">/* Tips : The end user has no way to know that the server node has received an abort SDO. */</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;                                <span class="comment">/* Its is ok, I think.*/</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;                        }</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                        <span class="keywordflow">else</span> { <span class="comment">/* If I am CLIENT */</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                                <span class="keywordflow">if</span> (!err) {</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                                        <span class="comment">/* The line *must* be released by the core program. */</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                                                d-&gt;transfers[line].state = SDO_ABORTED_RCV;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                                        d-&gt;transfers[line].abortCode = abortCode;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                                        MSG_WAR(0x3AB0, <span class="stringliteral">&quot;SD0. Received SDO abort. Line state ABORTED. Code : &quot;</span>, abortCode);</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                                }</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;                                        MSG_WAR(0x3AB1, <span class="stringliteral">&quot;SD0. Received SDO abort. No line found. Code : &quot;</span>, abortCode);</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                        }</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                <span class="keywordflow">case</span> 5: <span class="comment">/* Command specifier for data transmission - the client or server is the data producer */</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;                        SubCommand = <a class="code" href="sdo_8c.html#a80fb365a327b1fd8fda7f9634832f231">getSDOblockSC</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) { <span class="comment">/* Server block upload */</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                                <span class="keywordflow">if</span> (SubCommand == SDO_BCS_INITIATE_UPLOAD_REQUEST) {</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                                    index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                                    subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                                    MSG_WAR(0x3AB2, <span class="stringliteral">&quot;Received SDO Initiate block upload defined at index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                                                CliServNbr);</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                                    MSG_WAR(0x3AB3, <span class="stringliteral">&quot;Reading at index : &quot;</span>, index);</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                                    MSG_WAR(0x3AB4, <span class="stringliteral">&quot;Reading at subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                                    <span class="comment">/* Search if a SDO transfer have been yet initiated */</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                                    <span class="keywordflow">if</span> (! err) {</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                                            MSG_ERR(0x1A93, <span class="stringliteral">&quot;SDO error : Transmission yet started at line : &quot;</span>, line);</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                                            MSG_WAR(0x3AB5, <span class="stringliteral">&quot;Server Nbr = &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                                            <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                                            <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                                    }</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                                    <span class="comment">/* No line on use. Great !*/</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                                    <span class="comment">/* Try to open a new line.*/</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                                    err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, whoami, &amp;line );</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                                    <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                                            MSG_ERR(0x1A73, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;                                            <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                                            <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                                    }</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                                    <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliServNbr, index, subIndex, SDO_BLOCK_UPLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                    d-&gt;transfers[line].peerCRCsupport = ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])&gt;&gt;2) &amp; 1;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;                    d-&gt;transfers[line].blksize = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4];</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                                    <span class="comment">/* Transfer data from dictionary to the line structure. */</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                                    errorCode = <a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">objdictToSDOline</a>(d, line);</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                                    <span class="keywordflow">if</span> (errorCode) {</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                                            MSG_ERR(0x1A95, <span class="stringliteral">&quot;SDO error : Unable to copy the data from object dictionary. Err code : &quot;</span>,</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                                                        errorCode);</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                                            <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, errorCode);</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                                            <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;                                    }</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                                    <span class="comment">/* Preparing the response.*/</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                                    <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);     <span class="comment">/* get Nb bytes to transfer */</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                    d-&gt;transfers[line].objsize = nbBytes;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                    data[0] = (6 &lt;&lt; 5) | (1 &lt;&lt; 1) | SDO_BSS_INITIATE_UPLOAD_RESPONSE;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                                        data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                                        data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                                        data[3] = subIndex;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                                        data[4] = (UNS8) nbBytes;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                                        data[5] = (UNS8) (nbBytes &gt;&gt; 8);</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                                        data[6] = (UNS8) (nbBytes &gt;&gt; 16);</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                                        data[7] = (UNS8) (nbBytes &gt;&gt; 24);</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                                        MSG_WAR(0x3A9A, <span class="stringliteral">&quot;SDO. Sending normal block upload initiate response defined at index 0x1200 + &quot;</span>, nodeId);</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                }</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SubCommand == SDO_BCS_END_UPLOAD_REQUEST) {</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                                    MSG_WAR(0x3AA2, <span class="stringliteral">&quot;Received SDO block END upload request defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                                    <span class="comment">/* A SDO transfer should have been yet initiated. */</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                                    <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                                            err = d-&gt;transfers[line].state != SDO_BLOCK_UPLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                                    <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                                            MSG_ERR(0x1AA1, <span class="stringliteral">&quot;SDO error : Received block upload request for unstarted trans. index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                                                            CliServNbr);</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                                            <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                                            <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                                    }</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                    <span class="comment">/* Release the line */</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;                }</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((SubCommand == SDO_BCS_UPLOAD_RESPONSE) || (SubCommand == SDO_BCS_START_UPLOAD)) {</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                                    <span class="comment">/* A SDO transfer should have been yet initiated. */</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                                    <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                                            err = d-&gt;transfers[line].state != SDO_BLOCK_UPLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                                    <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                                            MSG_ERR(0x1AA1, <span class="stringliteral">&quot;SDO error : Received block upload response for unstarted trans. index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                                                            CliServNbr);</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                                            <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                                            <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                                    }</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;                                    <span class="comment">/* Reset the wathdog */</span></div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                                    RestartSDO_TIMER(line);</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;                                    <span class="comment">/* Uploading first or next block */</span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;                                    index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;                                    subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                    <span class="keywordflow">if</span> (SubCommand == SDO_BCS_UPLOAD_RESPONSE) {</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                                            MSG_WAR(0x3AA2, <span class="stringliteral">&quot;Received SDO block upload response defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;                        d-&gt;transfers[line].blksize = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2];</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                        AckSeq = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1]) &amp; 0x7f;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                        <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;                        <span class="keywordflow">if</span>((nbBytes == 0) &amp;&amp; (AckSeq == d-&gt;transfers[line].seqno)){ <span class="comment">/* Si tout est envoy et confirm reu on envoi un block end upload response */</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;                            data[0] = (6 &lt;&lt; 5) | ((d-&gt;transfers[line].endfield) &lt;&lt; 2) | SDO_BSS_END_UPLOAD_RESPONSE;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;                            <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;                                                        data[i] = 0;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;                                                MSG_WAR(0x3AA5, <span class="stringliteral">&quot;SDO. Sending block END upload response defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                        }</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                            d-&gt;transfers[line].offset = d-&gt;transfers[line].lastblockoffset + 7 * AckSeq;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                        <span class="keywordflow">if</span>(d-&gt;transfers[line].offset &gt; d-&gt;transfers[line].count) { <span class="comment">/* Bad AckSeq reveived (too high) */</span></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                                                MSG_ERR(0x1AA1, <span class="stringliteral">&quot;SDO error : Received upload response with bad ackseq index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;                                                            CliServNbr);</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                        }</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                                }</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;                                            MSG_WAR(0x3AA2, <span class="stringliteral">&quot;Received SDO block START upload defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                    d-&gt;transfers[line].lastblockoffset = (UNS8) d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                    <span class="keywordflow">for</span>(SeqNo = 1 ; SeqNo &lt;= d-&gt;transfers[line].blksize ; SeqNo++) {</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                                        <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                        <span class="keywordflow">if</span> (nbBytes &gt; 7) {</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                                                <span class="comment">/* The segment to transfer is not the last one.*/</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                                                data[0] = SeqNo;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, 7, data + 1);</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                                                }</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                                                MSG_WAR(0x3AA5, <span class="stringliteral">&quot;SDO. Sending upload segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;                                        }</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                                                <span class="comment">/* Last segment is in this block */</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                                                data[0] = 0x80 | SeqNo;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 1);</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                                                }</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                                                <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                                                        data[i] = 0;</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                                                MSG_WAR(0x3AA5, <span class="stringliteral">&quot;SDO. Sending last upload segment defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                            d-&gt;transfers[line].endfield = (UNS8) (7 - nbBytes);</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                                        }</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                    }</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                }</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                        }      <span class="comment">/* end if SERVER */</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                        <span class="keywordflow">else</span> { <span class="comment">/* if CLIENT (block download) */</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                <span class="keywordflow">if</span> ((SubCommand == SDO_BSS_INITIATE_DOWNLOAD_RESPONSE) || (SubCommand == SDO_BSS_DOWNLOAD_RESPONSE)) {</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                    <span class="comment">/* We should find a line opened for this. */</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                    <span class="keywordflow">if</span> (!err)</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                        err = d-&gt;transfers[line].state != SDO_BLOCK_DOWNLOAD_IN_PROGRESS;</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                    <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                        MSG_ERR(0x1AAA, <span class="stringliteral">&quot;SDO error : Received response for unknown block download request from node id&quot;</span>, nodeId);</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                    }</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                    <span class="comment">/* Reset the watchdog */</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;                    RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;                    <span class="keywordflow">if</span> (SubCommand == SDO_BSS_INITIATE_DOWNLOAD_RESPONSE) {</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                           index = d-&gt;transfers[line].index;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                        subIndex = d-&gt;transfers[line].subIndex;</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                        d-&gt;transfers[line].peerCRCsupport = ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])&gt;&gt;2) &amp; 1;</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                        d-&gt;transfers[line].blksize = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4];</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                    }</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                        d-&gt;transfers[line].blksize = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2];</div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                        AckSeq = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1]) &amp; 0x7f;</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                        <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                        <span class="keywordflow">if</span>((nbBytes == 0) &amp;&amp; (AckSeq == d-&gt;transfers[line].seqno)){ <span class="comment">/* Si tout est envoy et confirm reu on envoi un block end download request */</span></div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                            data[0] = (6 &lt;&lt; 5) | ((d-&gt;transfers[line].endfield) &lt;&lt; 2) | SDO_BCS_END_DOWNLOAD_REQUEST;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                            <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                                                        data[i] = 0;</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                                                MSG_WAR(0x3AA5, <span class="stringliteral">&quot;SDO. Sending block END download request defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                        }</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                            d-&gt;transfers[line].offset = d-&gt;transfers[line].lastblockoffset + 7 * AckSeq;</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                        <span class="keywordflow">if</span>(d-&gt;transfers[line].offset &gt; d-&gt;transfers[line].count) { <span class="comment">/* Bad AckSeq reveived (too high) */</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                                                MSG_ERR(0x1AA1, <span class="stringliteral">&quot;SDO error : Received upload segment with bad ackseq index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                                                            CliServNbr);</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                        }</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                                        }</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;                        d-&gt;transfers[line].lastblockoffset = (UNS8) d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;                        <span class="keywordflow">for</span>(SeqNo = 1 ; SeqNo &lt;= d-&gt;transfers[line].blksize ; SeqNo++) {</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;                                        <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;                        <span class="keywordflow">if</span> (nbBytes &gt; 7) {</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;                                                <span class="comment">/* The segment to transfer is not the last one.*/</span></div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;                                                data[0] = SeqNo;</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, 7, data + 1);</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                                                }</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                                                MSG_WAR(0x3AAB, <span class="stringliteral">&quot;SDO. Sending download segment to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;                                        }</div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;                                                <span class="comment">/* Last segment is in this block */</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                                                data[0] = 0x80 | SeqNo;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                                                err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a>(d, line, nbBytes, data + 1);</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;                                                }</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;                                                <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;                                                        data[i] = 0;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;                                                MSG_WAR(0x3AAB, <span class="stringliteral">&quot;SDO. Sending last download segment to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;                            d-&gt;transfers[line].endfield = (UNS8) (7 - nbBytes);</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;                                        }</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                    }</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                                }</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SubCommand == SDO_BSS_END_DOWNLOAD_RESPONSE) {</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                                        MSG_WAR(0x3AAC, <span class="stringliteral">&quot;SDO End block download response from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                                        StopSDO_TIMER(line)</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;                                        d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                                        <span class="keywordflow">return</span> 0x00;</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                                }</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;                                <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                                MSG_ERR(0x1AAB, <span class="stringliteral">&quot;SDO error block download : Received wrong subcommand from nodeId&quot;</span>, nodeId);</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;                                }</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;                        }      <span class="comment">/* end if CLIENT */</span></div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;                <span class="keywordflow">case</span> 6: <span class="comment">/* Command specifier for data reception - the client or server is the data consumer */</span></div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;                        <span class="keywordflow">if</span> (whoami == SDO_SERVER) { <span class="comment">/* Server block download */</span></div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;                                        <span class="comment">/* Nothing already started */</span></div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                                        SubCommand = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]) &amp; 1;</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;                                        <span class="keywordflow">if</span> (SubCommand != SDO_BCS_INITIATE_DOWNLOAD_REQUEST) {</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;                                    MSG_ERR(0x1AAC, <span class="stringliteral">&quot;SDO error block download : Received wrong subcommand from node id&quot;</span>, nodeId);</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;                                    <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;                                    <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                                    }</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;                                        index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;                                        subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;                                        MSG_WAR(0x3A9B, <span class="stringliteral">&quot;Received SDO block download initiate defined at index 0x1200 + &quot;</span>,</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;                                                CliServNbr);</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;                                        MSG_WAR(0x3A9B, <span class="stringliteral">&quot;Writing at index : &quot;</span>, index);</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;                                        MSG_WAR(0x3A9B, <span class="stringliteral">&quot;Writing at subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                                        <span class="comment">/* Try to open a new line. */</span></div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, whoami, &amp;line );</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                                                MSG_ERR(0x1A89, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;                                        }</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                                        <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliServNbr, index, subIndex, SDO_BLOCK_DOWNLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;                    d-&gt;transfers[line].rxstep = RXSTEP_STARTED;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;                    d-&gt;transfers[line].peerCRCsupport = ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])&gt;&gt;2) &amp; 1;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                                        <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]) &amp; 2)   <span class="comment">/* if data set size is indicated */</span></div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                        d-&gt;transfers[line].objsize = (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5]*256 + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6]*256*256 + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7]*256*256*256;</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                    data[0] = (5 &lt;&lt; 5) | SDO_BSS_INITIATE_DOWNLOAD_RESPONSE;</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                                        data[1] = (UNS8) index;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                                        data[2] = (UNS8) (index &gt;&gt; 8); <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                                        data[3] = subIndex;</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                                        data[4] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;                                        data[5] = data[6] = data[7] = 0;</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;                                        MSG_WAR(0x3AAD, <span class="stringliteral">&quot;SDO. Sending block download initiate response - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                                }</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;transfers[line].rxstep == RXSTEP_STARTED) {</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                                        MSG_WAR(0x3A9B, <span class="stringliteral">&quot;Received SDO block download data segment - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                        RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                                        SeqNo = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 0x7F;</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;                                        <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 0x80) {        <span class="comment">/* Last segment ? */</span></div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;                                            <span class="keywordflow">if</span>(SeqNo == (d-&gt;transfers[line].seqno + 1)) {</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;                                                        d-&gt;transfers[line].rxstep = RXSTEP_END;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;                                                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;                                                        <span class="comment">/* Store the data temporary because we don&#39;t know yet how many bytes do not contain data */</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;                                                        memcpy(d-&gt;transfers[line].tmpData, m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>, 8);</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;                                                }</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;                                                data[0] = (5 &lt;&lt; 5) | SDO_BSS_DOWNLOAD_RESPONSE;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;                                                data[1] = d-&gt;transfers[line].seqno;</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;                                                data[2] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                                                data[3] = data[4] = data[5] = data[6] = data[7] = 0;</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                                                MSG_WAR(0x3AAE, <span class="stringliteral">&quot;SDO. Sending block download response - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                        d-&gt;transfers[line].seqno = 0;</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;                                        }</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;                                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;                                                <span class="keywordflow">if</span> (SeqNo == (d-&gt;transfers[line].seqno + 1)) {  </div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;                                                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                                                        <span class="comment">/* Store the data in the transfer structure. */</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, 7, (*m).data + 1);</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;                                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index,  d-&gt;transfers[line].subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;                                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;                                                        }</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                                                }</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                                                <span class="keywordflow">if</span> (SeqNo == SDO_BLOCK_SIZE) {</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                                                        data[0] = (5 &lt;&lt; 5) | SDO_BSS_DOWNLOAD_RESPONSE;</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                                                        data[1] = d-&gt;transfers[line].seqno;</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;                                                        data[2] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                                                        data[3] = data[4] = data[5] = data[6] = data[7] = 0;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;                                                        MSG_WAR(0x3AAE, <span class="stringliteral">&quot;SDO. Sending block download response - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                            d-&gt;transfers[line].seqno = 0;</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;                                                }</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                                        }</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                                }</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;transfers[line].rxstep == RXSTEP_END) { <span class="comment">/* endphase */</span></div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;                                        MSG_WAR(0x3A9B, <span class="stringliteral">&quot;Received SDO block download end request - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;                                        <span class="comment">/* here store remaining bytes in tmpData to line, check size and confirm or abort */</span></div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;                                        <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 1) != SDO_BCS_END_DOWNLOAD_REQUEST) {</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;                                        MSG_ERR(0x1AAD, <span class="stringliteral">&quot;SDO error block download : Received wrong subcommand - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;                                        }</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                        RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                                        NbBytesNoData = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]&gt;&gt;2) &amp; 0x07;</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;                                        <span class="comment">/* Store the data in the transfer structure. */</span></div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, 7-NbBytesNoData, d-&gt;transfers[line].tmpData + 1);</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index,  d-&gt;transfers[line].subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                                        }</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].objsize){ <span class="comment">/* If size was indicated in the initiate request */</span></div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;                                                <span class="keywordflow">if</span> (d-&gt;transfers[line].objsize != d-&gt;transfers[line].offset){</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;                                                        MSG_ERR(0x1AAE, <span class="stringliteral">&quot;SDO error block download : sizes do not match - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;                                                }</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;                                        }</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                                        data[0] = (5 &lt;&lt; 5) | SDO_BSS_END_DOWNLOAD_RESPONSE;</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;                                        <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;                                        MSG_WAR(0x3AAF, <span class="stringliteral">&quot;SDO. Sending block download end response - index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;                                        <span class="comment">/* Transfering line data to object dictionary. */</span></div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;                                        errorCode = <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">SDOlineToObjdict</a>(d, line);</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;                                        <span class="keywordflow">if</span> (errorCode) {</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;                                                MSG_ERR(0x1AAF, <span class="stringliteral">&quot;SDO error : Unable to copy the data in the object dictionary&quot;</span>, 0);</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex, errorCode);</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;                                        }</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;                                        <span class="comment">/* Release of the line */</span></div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;                                        <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;                                        MSG_WAR(0x3AAF, <span class="stringliteral">&quot;SDO. End of block download defined at index 0x1200 + &quot;</span>, CliServNbr);</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;                                }</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;                    }      <span class="comment">/* end if SERVER */</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;                    <span class="keywordflow">else</span> { <span class="comment">/* if CLIENT (block upload) */</span></div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;                                <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;                                <span class="comment">/* Nothing already started */</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;                                MSG_ERR(0x1AAD, <span class="stringliteral">&quot;SDO error block upload : no transmission started&quot;</span>, nodeId);</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;                                }</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;                        RestartSDO_TIMER(line)</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;                                <span class="keywordflow">if</span> (d-&gt;transfers[line].rxstep == RXSTEP_INIT) {</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;                                    <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 1) == SDO_BSS_INITIATE_UPLOAD_RESPONSE) {</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                                            MSG_WAR(0x3A9C, <span class="stringliteral">&quot;Received SDO block upload response from node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;                                                d-&gt;transfers[line].rxstep = RXSTEP_STARTED;</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                        d-&gt;transfers[line].peerCRCsupport = ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])&gt;&gt;2) &amp; 1;</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                                            <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]) &amp; 2)       <span class="comment">/* if data set size is indicated */</span></div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;                            d-&gt;transfers[line].objsize = (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5]*256 + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6]*256*256 + (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7]*256*256*256;</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;                        data[0] = (5 &lt;&lt; 5) | SDO_BCS_START_UPLOAD;</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;                                            <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;                                                    data[i] = 0;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;                        MSG_WAR(0x3AB6, <span class="stringliteral">&quot;SDO. Sending block upload start to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;                                            <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;                    }</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;                }</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;transfers[line].rxstep == RXSTEP_STARTED) {</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;                                        SeqNo = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 0x7F;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;                                        <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 0x80) {        <span class="comment">/* Last segment ? */</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                                            <span class="keywordflow">if</span>(SeqNo == (d-&gt;transfers[line].seqno + 1)) {</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;                                                        d-&gt;transfers[line].rxstep = RXSTEP_END;</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;                                                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;                                                        <span class="comment">/* Store the data temporary because we don&#39;t know yet how many bytes do not contain data */</span></div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;                                                        memcpy(d-&gt;transfers[line].tmpData, m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>, 8);</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;                                                }</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                                                data[0] = (5 &lt;&lt; 5) | SDO_BCS_UPLOAD_RESPONSE;</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;                                                data[1] = d-&gt;transfers[line].seqno;</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;                                                data[2] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;                                                data[3] = data[4] = data[5] = data[6] = data[7] = 0;</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;                                                MSG_WAR(0x3AB7, <span class="stringliteral">&quot;SDO. Sending block upload response to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;                                                <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;                        d-&gt;transfers[line].seqno = 0;</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;                                        }</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;                                        <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;                                                <span class="keywordflow">if</span> (SeqNo == (d-&gt;transfers[line].seqno + 1)) {  </div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;                                                        d-&gt;transfers[line].seqno = SeqNo;</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;                                                        <span class="comment">/* Store the data in the transfer structure. */</span></div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;                                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, 7, (*m).data + 1);</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;                                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;                                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index,  d-&gt;transfers[line].subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;                                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;                                                        }</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;                                                }</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                                                <span class="keywordflow">if</span> (SeqNo == SDO_BLOCK_SIZE) {</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;                                                        data[0] = (5 &lt;&lt; 5) | SDO_BCS_UPLOAD_RESPONSE;</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;                                                        data[1] = d-&gt;transfers[line].seqno;</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;                                                        data[2] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;                                                        data[3] = data[4] = data[5] = data[6] = data[7] = 0;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;                                                        MSG_WAR(0x3AAE, <span class="stringliteral">&quot;SDO. Sending block upload response to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;                                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;                            d-&gt;transfers[line].seqno = 0;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                                                }</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                                        }</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;                                }</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;transfers[line].rxstep == RXSTEP_END) { <span class="comment">/* endphase */</span></div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;                                        <span class="comment">/* here store remaining bytes in tmpData to line, check size and confirm or abort */</span></div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;                                        <span class="keywordflow">if</span> ((m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0] &amp; 1) != SDO_BSS_END_UPLOAD_RESPONSE) {</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;                                        MSG_ERR(0x1AAD, <span class="stringliteral">&quot;SDO error block upload : Received wrong subcommand from node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;                                        }</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;                                        NbBytesNoData = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]&gt;&gt;2) &amp; 0x07;</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;                                        <span class="comment">/* Store the data in the transfer structure. */</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;                                        err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a>(d, line, 7-NbBytesNoData, d-&gt;transfers[line].tmpData + 1);</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;                                        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;                                                <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index,  d-&gt;transfers[line].subIndex, SDOABT_GENERAL_ERROR);</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;                                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;                                        }</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;                                        <span class="keywordflow">if</span>(d-&gt;transfers[line].objsize){ <span class="comment">/* If size was indicated in the initiate request */</span></div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;                                                <span class="keywordflow">if</span> (d-&gt;transfers[line].objsize != d-&gt;transfers[line].offset){</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;                                                        MSG_ERR(0x1AAE, <span class="stringliteral">&quot;SDO error block download : sizes do not match - from node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;                                                        <a class="code" href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a>(d, CliServNbr, whoami, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex, SDOABT_LOCAL_CTRL_ERROR);</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;                                                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;                                                }</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;                                        }</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;                                        data[0] = (5 &lt;&lt; 5) | SDO_BCS_END_UPLOAD_REQUEST;</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;                                        <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                                                data[i] = 0;</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                                        MSG_WAR(0x3AAF, <span class="stringliteral">&quot;SDO. Sending block upload end request to node id &quot;</span>, nodeId);</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;                                        <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, whoami, CliServNbr, data);</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;                                        MSG_WAR(0x3AAF, <span class="stringliteral">&quot;SDO. End of block upload request&quot;</span>, 0);</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;                    StopSDO_TIMER(line)</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;                                        d-&gt;transfers[line].state = SDO_FINISHED;</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;                                    <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;                                }</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;                        }      <span class="comment">/* end if CLIENT */</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                        <span class="comment">/* Error : Unknown cs */</span></div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                        MSG_ERR(0x1AB2, <span class="stringliteral">&quot;SDO. Received unknown command specifier : &quot;</span>, cs);</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        } <span class="comment">/* End switch */</span></div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;}</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;</div>
<div class="line"><a name="l01811"></a><span class="lineno"><a class="line" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33"> 1811</a></span>&#160;UNS8 <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>( <a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId )</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;{</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;        UNS8 SDOfound = 0;</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        UNS8 CliNbr;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        UNS16 lastIndex;</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        UNS8 nodeIdServer;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;        offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        <span class="keywordflow">if</span> (offset == 0) {</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;                MSG_ERR(0x1AC6, <span class="stringliteral">&quot;No SDO client index found for nodeId &quot;</span>, nodeId);</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        }</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;        CliNbr = 0;</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;        <span class="keywordflow">while</span> (offset &lt;= lastIndex) {</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;                <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;                        MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + CliNbr);</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;                }</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;                <span class="comment">/* looking for the server nodeId */</span></div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;                nodeIdServer = *((UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject);</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;                MSG_WAR(0x1AD2, <span class="stringliteral">&quot;index : &quot;</span>, 0x1280 + CliNbr);</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;                MSG_WAR(0x1AD3, <span class="stringliteral">&quot;nodeIdServer : &quot;</span>, nodeIdServer);</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;                <span class="keywordflow">if</span>(nodeIdServer == nodeId) {</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;                        SDOfound = 1;</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;                }</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;                offset++;</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;                CliNbr++;</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        } <span class="comment">/* end while */</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;        <span class="keywordflow">if</span> (!SDOfound) {</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;                MSG_WAR(0x1AC9, <span class="stringliteral">&quot;SDO No preset client found to communicate with node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;                <span class="keywordflow">return</span> 0xFE;</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;        }</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        MSG_WAR(0x3AD0,<span class="stringliteral">&quot;        SDO client defined at index  : &quot;</span>, 0x1280 + CliNbr);</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        <span class="keywordflow">return</span> CliNbr;</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;}</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;</div>
<div class="line"><a name="l01868"></a><span class="lineno"><a class="line" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651"> 1868</a></span>&#160;INLINE UNS8 <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index,</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize, UNS8 useBlockMode)</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;{</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;        UNS8 CliNbr;</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        UNS32 j;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        UNS8 buf[8];</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;        MSG_WAR(0x3AC0, <span class="stringliteral">&quot;Send SDO to write in the dictionary of node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;        MSG_WAR(0x3AC1, <span class="stringliteral">&quot;                                   At index : &quot;</span>, index);</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;        MSG_WAR(0x3AC2, <span class="stringliteral">&quot;                                   subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;        MSG_WAR(0x3AC3, <span class="stringliteral">&quot;                                   nb bytes : &quot;</span>, count);</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        <span class="comment">/* First let&#39;s find the corresponding SDO client in our OD  */</span></div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        CliNbr = <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>( d, nodeId);</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;        <span class="keywordflow">if</span>(CliNbr &gt;= 0xFE)</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;                <span class="keywordflow">return</span> CliNbr;</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;        <span class="comment">/* Verify that there is no SDO communication yet. */</span></div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>(d, CliNbr, SDO_CLIENT, &amp;line);</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        <span class="keywordflow">if</span> (!err) {</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;                MSG_ERR(0x1AC4, <span class="stringliteral">&quot;SDO error : Communication yet established. with node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        }</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;        <span class="comment">/* Taking the line ... */</span></div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, SDO_CLIENT, &amp;line );</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;                MSG_ERR(0x1AC5, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted for node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;                <span class="keywordflow">return</span> (0xFF);</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;        }</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;                MSG_WAR(0x3AE1, <span class="stringliteral">&quot;Transmission on line : &quot;</span>, line);</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    <span class="keywordflow">if</span>(useBlockMode) {</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;            <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliNbr, index, subIndex, SDO_BLOCK_DOWNLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;            d-&gt;transfers[line].objsize = count;</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    }</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="keywordflow">else</span> </div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;            <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliNbr, index, subIndex, SDO_DOWNLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        d-&gt;transfers[line].count = count;</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        d-&gt;transfers[line].dataType = dataType;</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;                UNS8* lineData = d-&gt;transfers[line].data;</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;                <span class="keywordflow">if</span> (count &gt; SDO_MAX_LENGTH_TRANSFER)</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                {</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;                        d-&gt;transfers[line].dynamicData = (UNS8*) malloc(count);</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;                        d-&gt;transfers[line].dynamicDataSize = count;</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;                        <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData == NULL)</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;                        {</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;                                MSG_ERR(0x1AC9, <span class="stringliteral">&quot;SDO. Error. Could not allocate enough bytes : &quot;</span>, count);</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;                                <span class="keywordflow">return</span> 0xFE;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;                        }</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;                        lineData = d-&gt;transfers[line].dynamicData;</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;                }</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;                <span class="comment">/* Copy data to transfers structure. */</span></div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;                <span class="keywordflow">for</span> (j = 0 ; j &lt; count ; j++) {</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span></div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="preprocessor"></span>                        <span class="keywordflow">if</span> (dataType == 0 &amp;&amp; endianize)</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;                                lineData[count - 1 - j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;                        <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;                                lineData[j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;<span class="preprocessor">#  else</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="preprocessor"></span>                        lineData[j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="preprocessor"></span>                }</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span></div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="preprocessor"></span>                <span class="keywordflow">if</span> (dataType == 0 &amp;&amp; endianize)</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;                        d-&gt;transfers[line].data[count - 1 - j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;                <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span></div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;                        d-&gt;transfers[line].data[j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="preprocessor">#  else</span></div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="preprocessor"></span>                d-&gt;transfers[line].data[j] = ((<span class="keywordtype">char</span> *)data)[j];</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="preprocessor"></span>        }</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    <span class="keywordflow">if</span>(useBlockMode) {</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;            buf[0] = (6 &lt;&lt; 5) | (1 &lt;&lt; 1 );   <span class="comment">/* CCS = 6 , CC = 0 , S = 1 , CS = 0 */</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;            <span class="keywordflow">for</span> (i = 0 ; i &lt; 4 ; i++)</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;                    buf[i+4] = (UNS8)((count &gt;&gt; (i&lt;&lt;3))); <span class="comment">/* i*8 */</span></div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;    }</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;            <span class="comment">/* Send the SDO to the server. Initiate download, cs=1. */</span></div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;            <span class="keywordflow">if</span> (count &lt;= 4) { <span class="comment">/* Expedited transfer */</span></div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;                    buf[0] = (UNS8)((1 &lt;&lt; 5) | ((4 - count) &lt;&lt; 2) | 3);</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;                    <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;                            buf[i] = d-&gt;transfers[line].data[i - 4];</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;                    d-&gt;transfers[line].offset = count;</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;            }</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;            <span class="keywordflow">else</span> { </div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;                    buf[0] = (1 &lt;&lt; 5) | 1;</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;                    <span class="keywordflow">for</span> (i = 0 ; i &lt; 4 ; i++)</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;                            buf[i+4] = (UNS8)((count &gt;&gt; (i&lt;&lt;3))); <span class="comment">/* i*8 */</span></div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;            }</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    }</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;        buf[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        buf[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;        buf[3] = subIndex;</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        d-&gt;transfers[line].Callback = Callback;</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        err = <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, SDO_CLIENT, CliNbr, buf);</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;                MSG_ERR(0x1AD1, <span class="stringliteral">&quot;SDO. Error while sending SDO to node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;                <span class="comment">/* release the line */</span></div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;                <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;        }</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;}</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;</div>
<div class="line"><a name="l01999"></a><span class="lineno"><a class="line" href="group__sdo.html#ga6a056a111cd07ce8fbb430d3d81cbb99"> 1999</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#ga6a056a111cd07ce8fbb430d3d81cbb99">writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index,</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;                UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, UNS8 useBlockMode)</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;{</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, NULL, 1, useBlockMode);</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;}</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;</div>
<div class="line"><a name="l02020"></a><span class="lineno"><a class="line" href="group__sdo.html#gaa1d75a97706ef2db3bd63d8e05a515a7"> 2020</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#gaa1d75a97706ef2db3bd63d8e05a515a7">writeNetworkDictCallBack</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index,</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;                UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 useBlockMode)</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;{</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, 1, useBlockMode);</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;}</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;</div>
<div class="line"><a name="l02026"></a><span class="lineno"><a class="line" href="group__sdo.html#gad7766666a4917fa5ddea3f0c9f60ae99"> 2026</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#gad7766666a4917fa5ddea3f0c9f60ae99">writeNetworkDictCallBackAI</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index,</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;                UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize, UNS8 useBlockMode)</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;{</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;        UNS8 ret;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;        UNS16 lastIndex;</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;        UNS8 nodeIdServer;</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;        ret = <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, endianize, useBlockMode);</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;        <span class="keywordflow">if</span>(ret == 0xFE)</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        {</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                <span class="keywordflow">if</span> (offset == 0)</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                {</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;                        MSG_ERR(0x1AC6, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                }</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;                i = 0;</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;                <span class="keywordflow">while</span> (offset &lt;= lastIndex)</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;                {</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                        <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3)</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                        {</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                                MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                        }</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                        nodeIdServer = *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                        <span class="keywordflow">if</span>(nodeIdServer == 0)</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;                        {</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;                                *(UNS32*)d-&gt;objdict[offset].pSubindex[1].pObject = (UNS32)(0x600 + nodeId);</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;                                *(UNS32*)d-&gt;objdict[offset].pSubindex[2].pObject = (UNS32)(0x580 + nodeId);</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;                                *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject = nodeId;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                                <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, endianize, useBlockMode);</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                        }</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;                        offset++;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                }</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;        }</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == 0)</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;        {</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        }</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        {</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        }</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;}</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;</div>
<div class="line"><a name="l02088"></a><span class="lineno"><a class="line" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a"> 2088</a></span>&#160;INLINE UNS8 <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;{</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        UNS8 CliNbr;</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        UNS8 data[8];</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;        MSG_WAR(0x3AD5, <span class="stringliteral">&quot;Send SDO to read in the dictionary of node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;        MSG_WAR(0x3AD6, <span class="stringliteral">&quot;                                  At index : &quot;</span>, index);</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        MSG_WAR(0x3AD7, <span class="stringliteral">&quot;                                  subIndex : &quot;</span>, subIndex);</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        <span class="comment">/* First let&#39;s find the corresponding SDO client in our OD  */</span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;        CliNbr = <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>( d, nodeId);</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        <span class="keywordflow">if</span>(CliNbr &gt;= 0xFE)</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;                <span class="keywordflow">return</span> CliNbr;</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;        <span class="comment">/* Verify that there is no SDO communication yet. */</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>(d, CliNbr, SDO_CLIENT, &amp;line);</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        <span class="keywordflow">if</span> (!err) {</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;                MSG_ERR(0x1AD8, <span class="stringliteral">&quot;SDO error : Communication yet established. with node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;        }</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;        <span class="comment">/* Taking the line ... */</span></div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;        err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a>( d, SDO_CLIENT, &amp;line );</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                MSG_ERR(0x1AD9, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted for node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;                <span class="keywordflow">return</span> (0xFF);</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;        }</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;                MSG_WAR(0x3AE0, <span class="stringliteral">&quot;Transmission on line : &quot;</span>, line);</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    <span class="keywordflow">if</span>(useBlockMode) {</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;            <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliNbr, index, subIndex, SDO_BLOCK_UPLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;            <span class="comment">/* Send the SDO to the server. Initiate block upload, cs=0. */</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;            d-&gt;transfers[line].dataType = dataType;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;            data[0] = (5 &lt;&lt; 5) | SDO_BCS_INITIATE_UPLOAD_REQUEST;</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;            data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;            data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;            data[3] = subIndex;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;            data[4] = SDO_BLOCK_SIZE;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;            <span class="keywordflow">for</span> (i = 5 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;                    data[i] = 0;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    }</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;            <a class="code" href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a>(d, line, CliNbr, index, subIndex, SDO_UPLOAD_IN_PROGRESS);</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;            <span class="comment">/* Send the SDO to the server. Initiate upload, cs=2. */</span></div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;            d-&gt;transfers[line].dataType = dataType;</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;            data[0] = (2 &lt;&lt; 5);</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;            data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span></div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;            data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;            data[3] = subIndex;</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;            <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                    data[i] = 0;</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    }</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;        d-&gt;transfers[line].Callback = Callback;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;        err = <a class="code" href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a>(d, SDO_CLIENT, CliNbr, data);</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                MSG_ERR(0x1AE5, <span class="stringliteral">&quot;SDO. Error while sending SDO to node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                <span class="comment">/* release the line */</span></div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;                <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;        }</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;}</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;</div>
<div class="line"><a name="l02166"></a><span class="lineno"><a class="line" href="group__sdo.html#ga4feff8e0b1f69e315f768661e0d818ba"> 2166</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#ga4feff8e0b1f69e315f768661e0d818ba">readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, UNS8 useBlockMode)</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;{</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, NULL, useBlockMode);</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;}</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div>
<div class="line"><a name="l02184"></a><span class="lineno"><a class="line" href="group__sdo.html#ga6b3b00106c4babb78e84c307ecc3d73c"> 2184</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#ga6b3b00106c4babb78e84c307ecc3d73c">readNetworkDictCallback</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;{</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback, useBlockMode);</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;}</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div>
<div class="line"><a name="l02189"></a><span class="lineno"><a class="line" href="group__sdo.html#ga1dde1086506324c8b8c0386f142fba40"> 2189</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#ga1dde1086506324c8b8c0386f142fba40">readNetworkDictCallbackAI</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;{</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        UNS8 ret;</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;        UNS16 lastIndex;</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        UNS16 offset;</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        UNS8 nodeIdServer;</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;        UNS8 i;</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;        ret = <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback, useBlockMode);</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;        <span class="keywordflow">if</span>(ret == 0xFE)</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;        {</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;                offset = d-&gt;firstIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;                lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;                <span class="keywordflow">if</span> (offset == 0)</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;                {</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;                        MSG_ERR(0x1AC6, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;                        <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;                }</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;                i = 0;</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;                <span class="keywordflow">while</span> (offset &lt;= lastIndex)</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;                {</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;                        <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3)</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;                        {</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;                                MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;                                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;                        }</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;                        nodeIdServer = *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                        <span class="keywordflow">if</span>(nodeIdServer == 0)</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                        {</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                                *(UNS32*)d-&gt;objdict[offset].pSubindex[1].pObject = (UNS32)(0x600 + nodeId);</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                                *(UNS32*)d-&gt;objdict[offset].pSubindex[2].pObject = (UNS32)(0x580 + nodeId);</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                                *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject = nodeId;</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;                                <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback, useBlockMode);</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;                        }</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;                        offset++;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;                }</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;        }</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == 0)</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;        {</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        }</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        {</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;                <span class="keywordflow">return</span> 0xFF;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;        }</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;}</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;</div>
<div class="line"><a name="l02251"></a><span class="lineno"><a class="line" href="group__sdo.html#gab8a362443447b15446e516130ececfe4"> 2251</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#gab8a362443447b15446e516130ececfe4">getReadResultNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, <span class="keywordtype">void</span>* data, UNS32 *size,</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;                UNS32 * abortCode)</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;{</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;        UNS32 i;</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;        UNS8 CliNbr;</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;        UNS8 line;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;        * abortCode = 0;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;        <span class="comment">/* First let&#39;s find the corresponding SDO client in our OD  */</span></div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;        CliNbr = <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>(d, nodeId);</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;        <span class="keywordflow">if</span>(CliNbr &gt;= 0xFE) {</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;        *size = 0;</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;                <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;    }</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        <span class="comment">/* Looking for the line tranfert. */</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>(d, CliNbr, SDO_CLIENT, &amp;line);</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;                MSG_ERR(0x1AF0, <span class="stringliteral">&quot;SDO error : No line found for communication with node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;        *size = 0;</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;        <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;        }</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    <span class="comment">/* If transfer not finished just return, but if aborted set abort code and size to 0 */</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;    <span class="keywordflow">if</span> (d-&gt;transfers[line].state != SDO_FINISHED) {</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;            <span class="keywordflow">if</span>((d-&gt;transfers[line].state == SDO_ABORTED_RCV) || (d-&gt;transfers[line].state == SDO_ABORTED_INTERNAL)) {</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;            *abortCode = d-&gt;transfers[line].abortCode;</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;            *size = 0;</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        }</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;                <span class="keywordflow">return</span> d-&gt;transfers[line].state;</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;    }</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;        <span class="comment">/* if SDO initiated with e=0 and s=0 count is null, offset carry effective size*/</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;        <span class="keywordflow">if</span>( d-&gt;transfers[line].count == 0)</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;                d-&gt;transfers[line].count = d-&gt;transfers[line].offset;</div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;</div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;    <span class="comment">/* Check if the provided buffer is big enough */</span></div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;    <span class="keywordflow">if</span>(*size &lt; d-&gt;transfers[line].count) {</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;                *size = 0;</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;                <span class="keywordflow">return</span> SDO_PROVIDED_BUFFER_TOO_SMALL;</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    }</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;        </div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    <span class="comment">/* Give back actual size */</span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    *size = d-&gt;transfers[line].count;</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;        <span class="comment">/* Copy payload to data pointer */</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="preprocessor">#ifdef SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="preprocessor"></span>        {</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;                UNS8 *lineData = d-&gt;transfers[line].data;</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;                <span class="keywordflow">if</span> (d-&gt;transfers[line].dynamicData &amp;&amp; d-&gt;transfers[line].dynamicDataSize)</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;                {</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;                        lineData = d-&gt;transfers[line].dynamicData;</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;                }</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;                <span class="keywordflow">for</span>  ( i = 0 ; i &lt; *size ; i++) {</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="preprocessor"></span>                        <span class="keywordflow">if</span> (d-&gt;transfers[line].dataType != visible_string)</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;                                ( (<span class="keywordtype">char</span> *) data)[*size - 1 - i] = lineData[i];</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;                        <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;                                ( (<span class="keywordtype">char</span> *) data)[i] = lineData[i];</div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;<span class="preprocessor"># else</span></div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="preprocessor"></span>                        ( (<span class="keywordtype">char</span> *) data)[i] = lineData[i];</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="preprocessor"># endif</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;<span class="preprocessor"></span>                }</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;        }</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="preprocessor">#else //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">for</span>  ( i = 0 ; i &lt; *size ; i++) {</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;<span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span></div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;<span class="preprocessor"></span>                <span class="keywordflow">if</span> (d-&gt;transfers[line].dataType != visible_string)</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;                        ( (<span class="keywordtype">char</span> *) data)[*size - 1 - i] = d-&gt;transfers[line].data[i];</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;                <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span></div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;                        ( (<span class="keywordtype">char</span> *) data)[i] = d-&gt;transfers[line].data[i];</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;<span class="preprocessor"># else</span></div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="preprocessor"></span>                ( (<span class="keywordtype">char</span> *) data)[i] = d-&gt;transfers[line].data[i];</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;<span class="preprocessor"># endif</span></div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="preprocessor"></span>        }</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="preprocessor">#endif //SDO_DYNAMIC_BUFFER_ALLOCATION</span></div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="preprocessor"></span>    <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;        <span class="keywordflow">return</span> SDO_FINISHED;</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;}</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;</div>
<div class="line"><a name="l02342"></a><span class="lineno"><a class="line" href="group__sdo.html#ga8671e306873f19362c60bb50ab930d1d"> 2342</a></span>&#160;UNS8 <a class="code" href="group__sdo.html#ga8671e306873f19362c60bb50ab930d1d">getWriteResultNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html">CO_Data</a>* d, UNS8 nodeId, UNS32 * abortCode)</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;{</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;        UNS8 line = 0;</div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;        UNS8 err;</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;        UNS8 CliNbr;</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;        * abortCode = 0;</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;        </div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        <span class="comment">/* First let&#39;s find the corresponding SDO client in our OD  */</span></div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;        CliNbr = <a class="code" href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a>(d, nodeId);</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;        <span class="keywordflow">if</span>(CliNbr &gt;= 0xFE)</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;                <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;        <span class="comment">/* Looking for the line tranfert. */</span></div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        err = <a class="code" href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a>(d, CliNbr, SDO_CLIENT, &amp;line);</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;        <span class="keywordflow">if</span> (err) {</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;                MSG_ERR(0x1AF1, <span class="stringliteral">&quot;SDO error : No line found for communication with node : &quot;</span>, nodeId);</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;                <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        }</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;        * abortCode = d-&gt;transfers[line].abortCode;</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="keywordflow">if</span> (d-&gt;transfers[line].state != SDO_FINISHED)</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;            <span class="keywordflow">return</span> d-&gt;transfers[line].state;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a>(d, line);</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        <span class="keywordflow">return</span> SDO_FINISHED;</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;}</div>
<div class="ttc" id="sdo_8c_html_a2f61d90737fb951b4b33c05e9b9810d7"><div class="ttname"><a href="sdo_8c.html#a2f61d90737fb951b4b33c05e9b9810d7">sendSDO</a></div><div class="ttdeci">UNS8 sendSDO(CO_Data *d, UNS8 whoami, UNS8 CliServNbr, UNS8 *pData)</div><div class="ttdoc">Transmit a SDO frame on the bus bus_id. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00662">sdo.c:662</a></div></div>
<div class="ttc" id="sdo_8c_html_a7ca56a650c5daaa24c89370f3b3d7bb0"><div class="ttname"><a href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">setSDOlineRestBytes</a></div><div class="ttdeci">UNS8 setSDOlineRestBytes(CO_Data *d, UNS8 line, UNS32 nbBytes)</div><div class="ttdoc">Store in the line structure the nb of bytes which must be transmited (or received) ...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00639">sdo.c:639</a></div></div>
<div class="ttc" id="group__od_html_ga811a637353eaa89cfae43957f7b3b68a"><div class="ttname"><a href="group__od.html#ga811a637353eaa89cfae43957f7b3b68a">getODentry</a></div><div class="ttdeci">#define getODentry(OD, wIndex, bSubindex, pDestData, pExpectedSize, pDataType,checkAccess)</div><div class="ttdoc">getODentry() to read from object and endianize </div><div class="ttdef"><b>Definition:</b> <a href="objacces_8h_source.html#l00144">objacces.h:144</a></div></div>
<div class="ttc" id="sdo_8c_html_a42d33be015d4c4c83c73f1f0e588f481"><div class="ttname"><a href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">resetSDOline</a></div><div class="ttdeci">void resetSDOline(CO_Data *d, UNS8 line)</div><div class="ttdoc">Reset an unused line. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00448">sdo.c:448</a></div></div>
<div class="ttc" id="sdo_8c_html_adfd3877d80f6b903b491a115e587bd14"><div class="ttname"><a href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">getSDOn2</a></div><div class="ttdeci">#define getSDOn2(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00096">sdo.c:96</a></div></div>
<div class="ttc" id="sdo_8c_html_ae5677ca12bfb71b06cbd6e99e9be0955"><div class="ttname"><a href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">getSDOn3</a></div><div class="ttdeci">#define getSDOn3(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00100">sdo.c:100</a></div></div>
<div class="ttc" id="structMessage_html_a41c5a4e7eaeb2c2ae1af2b2c83129615"><div class="ttname"><a href="structMessage.html#a41c5a4e7eaeb2c2ae1af2b2c83129615">Message::rtr</a></div><div class="ttdeci">UNS8 rtr</div><div class="ttdef"><b>Definition:</b> <a href="can_8h_source.html#l00034">can.h:34</a></div></div>
<div class="ttc" id="group__od_html_ga3417b8ecd54a73528afc30b77f7d464c"><div class="ttname"><a href="group__od.html#ga3417b8ecd54a73528afc30b77f7d464c">setODentry</a></div><div class="ttdeci">#define setODentry(d, wIndex, bSubindex, pSourceData, pExpectedSize, checkAccess)</div><div class="ttdoc">setODentry converts SourceData from network byte order to machine native format, and writes that to O...</div><div class="ttdef"><b>Definition:</b> <a href="objacces_8h_source.html#l00233">objacces.h:233</a></div></div>
<div class="ttc" id="sdo_8c_html_acf60675f20de8746e279dce3a5c8e3c6"><div class="ttname"><a href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">getSDOe</a></div><div class="ttdeci">#define getSDOe(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00104">sdo.c:104</a></div></div>
<div class="ttc" id="sdo_8c_html_a464b29fd628d92426de0a841232bdd12"><div class="ttname"><a href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a></div><div class="ttdeci">#define getSDOt(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00116">sdo.c:116</a></div></div>
<div class="ttc" id="group__sdo_html_ga4feff8e0b1f69e315f768661e0d818ba"><div class="ttname"><a href="group__sdo.html#ga4feff8e0b1f69e315f768661e0d818ba">readNetworkDict</a></div><div class="ttdeci">UNS8 readNetworkDict(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to read. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02166">sdo.c:2166</a></div></div>
<div class="ttc" id="group__sdo_html_ga6b3b00106c4babb78e84c307ecc3d73c"><div class="ttname"><a href="group__sdo.html#ga6b3b00106c4babb78e84c307ecc3d73c">readNetworkDictCallback</a></div><div class="ttdeci">UNS8 readNetworkDictCallback(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to read in a distant node dictionnary. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02184">sdo.c:2184</a></div></div>
<div class="ttc" id="sdo_8c_html_a80fb365a327b1fd8fda7f9634832f231"><div class="ttname"><a href="sdo_8c.html#a80fb365a327b1fd8fda7f9634832f231">getSDOblockSC</a></div><div class="ttdeci">#define getSDOblockSC(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00128">sdo.c:128</a></div></div>
<div class="ttc" id="group__sdo_html_ga1dde1086506324c8b8c0386f142fba40"><div class="ttname"><a href="group__sdo.html#ga1dde1086506324c8b8c0386f142fba40">readNetworkDictCallbackAI</a></div><div class="ttdeci">UNS8 readNetworkDictCallbackAI(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to read in a distant node dictionnary. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02189">sdo.c:2189</a></div></div>
<div class="ttc" id="sdo_8c_html_a77f638cbd9aca7bb67056e0cda945651"><div class="ttname"><a href="sdo_8c.html#a77f638cbd9aca7bb67056e0cda945651">_writeNetworkDict</a></div><div class="ttdeci">INLINE UNS8 _writeNetworkDict(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS32 count, UNS8 dataType, void *data, SDOCallback_t Callback, UNS8 endianize, UNS8 useBlockMode)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l01868">sdo.c:1868</a></div></div>
<div class="ttc" id="sdo_8c_html_a8d0032d382891d6804947e9514fe3720"><div class="ttname"><a href="sdo_8c.html#a8d0032d382891d6804947e9514fe3720">sendSDOabort</a></div><div class="ttdeci">UNS8 sendSDOabort(CO_Data *d, UNS8 whoami, UNS8 CliServNbr, UNS16 index, UNS8 subIndex, UNS32 abortCode)</div><div class="ttdoc">Transmit a SDO error to the client. The reasons may be : Read/Write to a undefined object Read/Write ...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00715">sdo.c:715</a></div></div>
<div class="ttc" id="structMessage_html_a0db105376ab9105abfcd15d56ea130d8"><div class="ttname"><a href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">Message::cob_id</a></div><div class="ttdeci">UNS16 cob_id</div><div class="ttdef"><b>Definition:</b> <a href="can_8h_source.html#l00033">can.h:33</a></div></div>
<div class="ttc" id="sdo_8c_html_a83b35f348d36c23421eb1753df96fc33"><div class="ttname"><a href="sdo_8c.html#a83b35f348d36c23421eb1753df96fc33">GetSDOClientFromNodeId</a></div><div class="ttdeci">UNS8 GetSDOClientFromNodeId(CO_Data *d, UNS8 nodeId)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l01811">sdo.c:1811</a></div></div>
<div class="ttc" id="sdo_8c_html_a1f4f07eccc4890a11ccf4f632da7740b"><div class="ttname"><a href="sdo_8c.html#a1f4f07eccc4890a11ccf4f632da7740b">resetSDO</a></div><div class="ttdeci">void resetSDO(CO_Data *d)</div><div class="ttdoc">Reset all SDO buffers. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00186">sdo.c:186</a></div></div>
<div class="ttc" id="sdo_8c_html_a2b662491084d03f3ad43d280a45ef23e"><div class="ttname"><a href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">lineToSDO</a></div><div class="ttdeci">UNS8 lineToSDO(CO_Data *d, UNS8 line, UNS32 nbBytes, UNS8 *data)</div><div class="ttdoc">Copy data from an existant line in the argument &quot;* data&quot;. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00302">sdo.c:302</a></div></div>
<div class="ttc" id="sdo_8c_html_a306682ff5ce933d4db07547e467e9057"><div class="ttname"><a href="sdo_8c.html#a306682ff5ce933d4db07547e467e9057">getSDOlineToClose</a></div><div class="ttdeci">UNS8 getSDOlineToClose(CO_Data *d, UNS8 CliServNbr, UNS8 whoami, UNS8 *line)</div><div class="ttdoc">Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00567">sdo.c:567</a></div></div>
<div class="ttc" id="group__sdo_html_gad7766666a4917fa5ddea3f0c9f60ae99"><div class="ttname"><a href="group__sdo.html#gad7766666a4917fa5ddea3f0c9f60ae99">writeNetworkDictCallBackAI</a></div><div class="ttdeci">UNS8 writeNetworkDictCallBackAI(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS32 count, UNS8 dataType, void *data, SDOCallback_t Callback, UNS8 endianize, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to write in a distant node dictionnary. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02026">sdo.c:2026</a></div></div>
<div class="ttc" id="structstruct__CO__Data_html"><div class="ttname"><a href="structstruct__CO__Data.html">struct_CO_Data</a></div><div class="ttdoc">This structure contains all necessary informations to define a CANOpen node. </div><div class="ttdef"><b>Definition:</b> <a href="data_8h_source.html#l00056">data.h:56</a></div></div>
<div class="ttc" id="sdo_8c_html_a29427a80fd1aeabff30bf0602fbc220f"><div class="ttname"><a href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">objdictToSDOline</a></div><div class="ttdeci">UNS32 objdictToSDOline(CO_Data *d, UNS8 line)</div><div class="ttdoc">Copy the data from the object dictionary to the SDO line for a network transfer. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00244">sdo.c:244</a></div></div>
<div class="ttc" id="structMessage_html"><div class="ttname"><a href="structMessage.html">Message</a></div><div class="ttdoc">The CAN message structure. </div><div class="ttdef"><b>Definition:</b> <a href="can_8h_source.html#l00032">can.h:32</a></div></div>
<div class="ttc" id="structMessage_html_a229865b09691e658677ba76f2d82ce89"><div class="ttname"><a href="structMessage.html#a229865b09691e658677ba76f2d82ce89">Message::data</a></div><div class="ttdeci">UNS8 data[8]</div><div class="ttdef"><b>Definition:</b> <a href="can_8h_source.html#l00036">can.h:36</a></div></div>
<div class="ttc" id="sdo_8c_html_a2eb5309dca3a7363da5e5e7230b85d58"><div class="ttname"><a href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">SDOlineToObjdict</a></div><div class="ttdeci">UNS32 SDOlineToObjdict(CO_Data *d, UNS8 line)</div><div class="ttdoc">Copy the data received from the SDO line transfer to the object dictionary. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00203">sdo.c:203</a></div></div>
<div class="ttc" id="structMessage_html_ad1dd9a88dda088ff4c7073d49613613d"><div class="ttname"><a href="structMessage.html#ad1dd9a88dda088ff4c7073d49613613d">Message::len</a></div><div class="ttdeci">UNS8 len</div><div class="ttdef"><b>Definition:</b> <a href="can_8h_source.html#l00035">can.h:35</a></div></div>
<div class="ttc" id="sdo_8c_html_ae5a2dafe8497bff1fd88f881ea74414d"><div class="ttname"><a href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">getSDOc</a></div><div class="ttdeci">#define getSDOc(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00112">sdo.c:112</a></div></div>
<div class="ttc" id="sdo_8c_html_a5efdbb02d210aad29c6d162600d3ae55"><div class="ttname"><a href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">SDOtoLine</a></div><div class="ttdeci">UNS8 SDOtoLine(CO_Data *d, UNS8 line, UNS32 nbBytes, UNS8 *data)</div><div class="ttdoc">Add data to an existant line. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00352">sdo.c:352</a></div></div>
<div class="ttc" id="sdo_8c_html_a3a6660620ea5fb37d311afc3d9a301c2"><div class="ttname"><a href="sdo_8c.html#a3a6660620ea5fb37d311afc3d9a301c2">getSDOlineOnUse</a></div><div class="ttdeci">UNS8 getSDOlineOnUse(CO_Data *d, UNS8 CliServNbr, UNS8 whoami, UNS8 *line)</div><div class="ttdoc">Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00540">sdo.c:540</a></div></div>
<div class="ttc" id="sdo_8c_html_aa570e2c8e69527298b428563a38ced9f"><div class="ttname"><a href="sdo_8c.html#aa570e2c8e69527298b428563a38ced9f">initSDOline</a></div><div class="ttdeci">UNS8 initSDOline(CO_Data *d, UNS8 line, UNS8 CliServNbr, UNS16 index, UNS8 subIndex, UNS8 state)</div><div class="ttdoc">Initialize some fields of the structure. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00471">sdo.c:471</a></div></div>
<div class="ttc" id="sdo_8c_html_af7f9e9bc3d59c9772d4c767b199dcf89"><div class="ttname"><a href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">getSDOs</a></div><div class="ttdeci">#define getSDOs(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00108">sdo.c:108</a></div></div>
<div class="ttc" id="sdo_8c_html_ace5a1634ff4089db3b228cdd5010c321"><div class="ttname"><a href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">getSDOcs</a></div><div class="ttdeci">#define getSDOcs(byte)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00092">sdo.c:92</a></div></div>
<div class="ttc" id="sdo_8c_html_ad9b34e26bf67f1251f3bb364756e17f1"><div class="ttname"><a href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a></div><div class="ttdeci">#define getSDOindex(byte1, byte2)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00120">sdo.c:120</a></div></div>
<div class="ttc" id="group__sdo_html_ga8671e306873f19362c60bb50ab930d1d"><div class="ttname"><a href="group__sdo.html#ga8671e306873f19362c60bb50ab930d1d">getWriteResultNetworkDict</a></div><div class="ttdeci">UNS8 getWriteResultNetworkDict(CO_Data *d, UNS8 nodeId, UNS32 *abortCode)</div><div class="ttdoc">Use this function after calling writeNetworkDict function to get the result of the write...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02342">sdo.c:2342</a></div></div>
<div class="ttc" id="sdo_8c_html_a50665fc13aa385b1b523013cf9166523"><div class="ttname"><a href="sdo_8c.html#a50665fc13aa385b1b523013cf9166523">failedSDO</a></div><div class="ttdeci">UNS8 failedSDO(CO_Data *d, UNS8 CliServNbr, UNS8 whoami, UNS16 index, UNS8 subIndex, UNS32 abortCode)</div><div class="ttdoc">Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00416">sdo.c:416</a></div></div>
<div class="ttc" id="sdo_8c_html_a555a772d3a88a29c495f33513f8b2d58"><div class="ttname"><a href="sdo_8c.html#a555a772d3a88a29c495f33513f8b2d58">closeSDOtransfer</a></div><div class="ttdeci">UNS8 closeSDOtransfer(CO_Data *d, UNS8 nodeId, UNS8 whoami)</div><div class="ttdoc">Close a transmission. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00593">sdo.c:593</a></div></div>
<div class="ttc" id="sdo_8c_html_a52a96f6fa6083f6b291133135b7155a8"><div class="ttname"><a href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a></div><div class="ttdeci">#define getSDOsubIndex(byte3)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00124">sdo.c:124</a></div></div>
<div class="ttc" id="sdo_8c_html_a9309025e29b59e09026abcd3b45a5b61"><div class="ttname"><a href="sdo_8c.html#a9309025e29b59e09026abcd3b45a5b61">SDOTimeoutAlarm</a></div><div class="ttdeci">void SDOTimeoutAlarm(CO_Data *d, UNS32 id)</div><div class="ttdoc">Reset of a SDO exchange on timeout. Send a SDO abort. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00137">sdo.c:137</a></div></div>
<div class="ttc" id="sdo_8c_html_a2a93a7c780472b1d8666d89aa270f661"><div class="ttname"><a href="sdo_8c.html#a2a93a7c780472b1d8666d89aa270f661">proceedSDO</a></div><div class="ttdeci">UNS8 proceedSDO(CO_Data *d, Message *m)</div><div class="ttdoc">Treat a SDO frame reception call the function sendSDO. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00745">sdo.c:745</a></div></div>
<div class="ttc" id="group__sdo_html_gaa1d75a97706ef2db3bd63d8e05a515a7"><div class="ttname"><a href="group__sdo.html#gaa1d75a97706ef2db3bd63d8e05a515a7">writeNetworkDictCallBack</a></div><div class="ttdeci">UNS8 writeNetworkDictCallBack(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS32 count, UNS8 dataType, void *data, SDOCallback_t Callback, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to write in a distant node dictionnary. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02020">sdo.c:2020</a></div></div>
<div class="ttc" id="sdo_8c_html_a58d1f9691977617601beb9e5b4123252"><div class="ttname"><a href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">getSDOfreeLine</a></div><div class="ttdeci">UNS8 getSDOfreeLine(CO_Data *d, UNS8 whoami, UNS8 *line)</div><div class="ttdoc">Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00514">sdo.c:514</a></div></div>
<div class="ttc" id="group__sdo_html_ga6a056a111cd07ce8fbb430d3d81cbb99"><div class="ttname"><a href="group__sdo.html#ga6a056a111cd07ce8fbb430d3d81cbb99">writeNetworkDict</a></div><div class="ttdeci">UNS8 writeNetworkDict(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS32 count, UNS8 dataType, void *data, UNS8 useBlockMode)</div><div class="ttdoc">Used to send a SDO request frame to write the data at the index and subIndex indicated. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l01999">sdo.c:1999</a></div></div>
<div class="ttc" id="sdo_8c_html_aeb8bae9faa885c97486d84e951888e4a"><div class="ttname"><a href="sdo_8c.html#aeb8bae9faa885c97486d84e951888e4a">_readNetworkDict</a></div><div class="ttdeci">INLINE UNS8 _readNetworkDict(CO_Data *d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback, UNS8 useBlockMode)</div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02088">sdo.c:2088</a></div></div>
<div class="ttc" id="group__sdo_html_gab8a362443447b15446e516130ececfe4"><div class="ttname"><a href="group__sdo.html#gab8a362443447b15446e516130ececfe4">getReadResultNetworkDict</a></div><div class="ttdeci">UNS8 getReadResultNetworkDict(CO_Data *d, UNS8 nodeId, void *data, UNS32 *size, UNS32 *abortCode)</div><div class="ttdoc">Use this function after calling readNetworkDict to get the result. </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l02251">sdo.c:2251</a></div></div>
<div class="ttc" id="sdo_8c_html_a7654021041675c1389fd2d1b590ff7cb"><div class="ttname"><a href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">getSDOlineRestBytes</a></div><div class="ttdeci">UNS8 getSDOlineRestBytes(CO_Data *d, UNS8 line, UNS32 *nbBytes)</div><div class="ttdoc">Bytes in the line structure which must be transmited (or received) </div><div class="ttdef"><b>Definition:</b> <a href="sdo_8c_source.html#l00620">sdo.c:620</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="sdo_8c.html">sdo.c</a></li>
    <li class="footer">Generated on Fri Aug 21 2015 00:44:19 for CanFestival by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
